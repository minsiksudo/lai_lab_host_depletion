---
title: "COD_20240509_HOST_7_ATS024_figure"
author: "Minsik Kim"
date: "2024-02-12"
output:
    rmdformats::downcute:
        downcute_theme: "chaos"
        code_folding: hide
        fig_width: 6
        fig_height: 6
        df_print: paged
editor_options: 
  chunk_output_type: inline
  markdown: 
    wrap: 72
---

# Loading packages

```{r warning=FALSE, message=FALSE, setup}
#===============================================================================
#BTC.LineZero.Header.1.1.0
#===============================================================================
#R Markdown environment setup and reporting utility.
#===============================================================================
#RLB.Dependencies:
#   knitr, magrittr, pacman, rio, rmarkdown, rmdformats, tibble, yaml
#===============================================================================
#Input for document parameters, libraries, file paths, and options.
#=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=+=
#knitr::opts_chunk$set(message=FALSE, warning = FALSE)


path_working <- 
        ifelse(sessionInfo()[1]$R.version$platform == "x86_64-pc-linux-gnu",
               "/mnt/240_intel/Dropbox/",
               ifelse(sessionInfo()[1]$R.version$platform == "aarch64-apple-darwin20",
                      "/Volumes/macdrive/Dropbox/", 
                      "/Users/minsikkim/Dropbox (Personal)"))

path_library <- 
        ifelse(sessionInfo()[1]$R.version$platform == "x86_64-pc-linux-gnu",
               "/home/bagel/R/x86_64-pc-linux-gnu-library/4.1/",
               "/Library/Frameworks/R.framework/Resources/library/")

str_libraries <- c("readxl", "phyloseq", "tidyverse", "pacman", "yaml", "ggplot2", "vegan", "microbiome", "ggpubr", "viridis", "decontam", "gridExtra", "ggpubr", "lme4", "lmerTest", "writexl", "harrietr", "Maaslin2", "ggtext", "ggpmisc", "gamm4", "reshape2", "kableExtra", "knitr", "ggtree", "car", "mediation", "lemon", "qvalue", "gridtext")
        
YAML_header <-
'---
title: "Host-DNA depletion analysis of bacterio phage"
author: "Minsik Kim"
date: "2024.02.12"
output:
    rmdformats::downcute:
        downcute_theme: "chaos"
        code_folding: hide
        fig_width: 6
        fig_height: 6
---'
seed <- "20230925"

#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
#Loads libraries, file paths, and other document options.
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
FUN.LineZero.Boot <- function() {
    .libPaths(path_library)

    require(pacman)
    pacman::p_load(c("knitr", "rmarkdown", "rmdformats", "yaml"))

    knitr::opts_knit$set(root.dir = path_working)

    str_libraries |> unique() |> sort() -> str_libraries
    pacman::p_load(char = str_libraries)

    set.seed(seed)
}
FUN.LineZero.Boot()
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
#Outputs R environment report.
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

FUN.LineZero.Report <- function() {
    cat("Line Zero Environment:\n\n")
    paste("R:", pacman::p_version(), "\n") |> cat()
    cat("Libraries:\n")
    for (str_libraries in str_libraries) {
        paste(
            "    ", str_libraries, ": ", pacman::p_version(package = str_libraries),
            "\n", sep = ""
        ) |> cat()
    }
    paste("\nOperating System:", pacman::p_detectOS(), "\n") |> cat()
    paste("    Library Path:", path_library, "\n") |> cat()
    paste("    Working Path:", path_working, "\n") |> cat()
    paste("Seed:", seed, "\n\n") |> cat()
    cat("YAML Header:\n")
    cat(YAML_header)
}
FUN.LineZero.Report()

```

# DA analsyis

## DA viral host at genus level {.tabset}

### Factors affecting DA taxa (main text)

```{r, warning=FALSE, message=FALSE}
setwd("Project_SICAS2_microbiome/5_Scripts/MGK/Host_depletion_git")

#filt_maaslin_all <- read.csv("data/mrkrmg_host_da_lmer_filt_maaslin_all.csv")
#filt_fit_data_bal <- read.csv("data/mrkrmg_host_da_lmer_filt_fit_data_bal.csv")
#filt_fit_data_spt <- read.csv("data/mrkrmg_host_da_lmer_filt_fit_data_spt.csv")
#filt_fit_data_ns <- read.csv("data/mrkrmg_host_da_lmer_filt_fit_data_ns.csv")




filt_maaslin_all_v_h <- read.csv("/Volumes/macdrive/Dropbox/Git/Host_depletion_macmini/data/mrkrmg_host_da_lmer_filt_maaslin_all.csv")
#filt_maaslin_interaction <- read.csv("data/da_lmer_filt_maaslin_interaction.csv")
filt_fit_data_bal_v_h <- read.csv("/Volumes/macdrive/Dropbox/Git/Host_depletion_macmini/data/mrkrmg_host_da_lmer_filt_fit_data_bal.csv")
filt_fit_data_spt_v_h <- read.csv("/Volumes/macdrive/Dropbox/Git/Host_depletion_macmini/data/mrkrmg_host_da_lmer_filt_fit_data_spt.csv")
filt_fit_data_ns_v_h <- read.csv("/Volumes/macdrive/Dropbox/Git/Host_depletion_macmini/data/mrkrmg_host_da_lmer_filt_fit_data_ns.csv")
#filt_fit_data_pos <- read.csv("data/da_lmer_filt_fit_data_pos.csv")

```

### MaAsLin output (raw data)

```{r}
filt_maaslin_all_v_h
```

### MaAsLin output (stratified)

BAL stratified MaAsLin result

```{r}
filt_fit_data_bal_v_h
```

Nasal stratified MaAsLin result

```{r}
filt_fit_data_ns_v_h
```

Sputum stratified MaAsLin result

```{r}
filt_fit_data_spt_v_h
```

### Number of taxa on some conditions

These calculations were made to write the details in the main text

```{r}

cat("Factors affecting DA taxa (q<0.1)")
filt_maaslin_all_v_h %>% subset(., .$qval < 0.1 ) %>% .$metadata %>% table

cat("Number of positive & significant changes")
filt_maaslin_all_v_h %>% subset(., .$qval < 0.1 ) %>% subset(., .$Estimate > 0) %>% .$feature %>% unique

cat("Number of negative & significant changes")
filt_maaslin_all_v_h %>% subset(., .$qval < 0.1 ) %>% subset(., .$Estimate < 0) %>% .$feature %>% unique

cat("BAL highly changed taxa (q<0.1 & abs(.$coef) >1)")
filt_fit_data_bal_v_h %>% subset(., .$qval < 0.1 ) %>% subset(., abs(.$Estimate) >1 ) %>% .$metadata %>% table

cat("Sputum highly changed taxa (q<0.1 & abs(.$coef) >1)")
filt_fit_data_spt_v_h %>% subset(., .$qval < 0.1 ) %>% subset(., abs(.$Estimate) >1 ) %>% .$metadata %>% table

cat("NS highly changed taxa (q<0.1 & abs(.$coef) >1)")
filt_fit_data_ns_v_h %>% subset(., .$qval < 0.1 ) %>% subset(., abs(.$Estimate) >1 ) %>% .$metadata %>% table



cat("NS taxa (q<0.1)")
filt_fit_data_bal_v_h %>% subset(., .$qval < 0.1 ) %>% .$feature %>% unique

cat("NS taxa (q<0.1)")
filt_fit_data_ns_v_h %>% subset(., .$qval < 0.1 ) %>% .$feature %>% unique

cat("Sputum taxa (q<0.1 & abs(.$coef) >1)")
filt_fit_data_spt_v_h %>% subset(., .$qval < 0.1 ) %>% .$feature %>% unique


cat("Sputum taxa (q<0.1 & abs(.$coef) >1)")
filt_fit_data_spt_v_h %>% subset(., .$qval < 0.1 ) %>% .$metadata %>% table




```

### Fig. S8. Volcano plot


**Fig. S8.** Volcano plot of differential abundance of microbes by each treatment with a model MaAsLin (relative abundance of each taxa ~ sample type + lyPMA + Benzonase + HostZERO + MolYsis + QIAamp, random effect = subject id).

```{r warning=FALSE, message=FALSE}

#Making significance table for figure
        # Define a function to make species names italicized
# Make a significance table for each figure (top 20 taxa)
 
species_italic <- function(data) {
  names <- gsub("_A|_B", "", rownames(data))
  names <- gsub("_", " ", rownames(data))
  names <- gsub("[]]|[[]", "", names)
  names <- gsub(" sp", " sp.", names)
  names <- gsub(" sp.", "* sp.", names)
  names <- gsub(" group", "", names)
  names <- ifelse(grepl("[*]", names), paste("*", names, sep = ""), paste("*", names, "*", sep = ""))
  names <- ifelse(grepl("\\d", names),
                  names %>% gsub("[*]", "", .),
                  names)
  rownames(data) <- names
  data
}

species_revise <- function(data) {
  data$feature <- gsub("Saccharomyces_cerevisiae_x_Saccharomyces_kudriavzevii", "S._cerevisiae x S._kudriavzevii", data$feature)
  data$feature <- gsub("Pseudomonas_aeruginosa_group", "Pseudomonas_aeruginosa", data$feature)
  data$feature <- gsub("Pseudomonas_fluorescens_group", "Pseudomonas_fluorescens", data$feature)
  data
}





make_sig_table <- function(data, number) {
  sig_data <- spread(data[order(data$qval), c("feature", "metadata", "qval")], metadata, qval)
  sig_data <- species_revise(sig_data)
  sig_data$min <- apply(sig_data %>% dplyr::select(c("lypma", "benzonase", "molysis", "host_zero", "qiaamp")), 1, FUN = min)
  sig_data <- sig_data[order(sig_data$min),] %>% dplyr::select("feature", "lypma", "benzonase", "host_zero", "molysis", "qiaamp") %>% .[1:number,]
  sig_data[["feature"]] <- ifelse(sig_data[["feature"]] == "X.Collinsella._massiliensis", "[Collinsella]_massiliensis", sig_data[["feature"]])
  sig_data_italic <- sig_data %>% rownames_to_column(var = "-") %>%
          column_to_rownames(var = "feature") %>% species_italic %>% dplyr::select(-c("-")) %>%
          rename(lyPMA = lypma,  Benzonase = benzonase, `HostZERO` = host_zero, MolYsis = molysis, QIAamp = qiaamp)
  sig_data_sig <- ifelse(sig_data_italic < 0.1, "*", NA) %>% data.frame(check.names = F)
  return(list(data = sig_data, data_italic = sig_data_italic, data_sig = sig_data_sig))
}



#filt_fit_data_pos <- make_sig_table(filt_fit_data_pos)
filt_fit_data_bal <- make_sig_table(filt_fit_data_bal_v_h, 17)
filt_fit_data_ns <- make_sig_table(filt_fit_data_ns_v_h, 8)
filt_fit_data_spt <- make_sig_table(filt_fit_data_spt_v_h, 20)


filt_spt_sig <- subset_taxa(
        subset_samples(v_h_phyloseq_rel_renamed, sample_type == "Sputum"),
        (taxa_names(subset_samples(v_h_phyloseq_rel_renamed, sample_type == "Sputum")) %in%
                filt_fit_data_spt$data$feature))

filt_fit_data_spt$rel <- cbind(filt_spt_sig %>% otu_table %>% t, filt_spt_sig %>% sample_data) %>% group_by(treatment) %>% summarise_if(is.numeric, mean, na.rm = TRUE) %>% .[, 1:21] %>% column_to_rownames(., "treatment") %>% t () %>% species_italic() %>%  data.frame(check.names = F) %>% 
        .[row.names(filt_fit_data_spt$data_italic),] %>%  mutate_all(~na_if(., 0)) %>% rownames_to_column("feature")

filt_ns_sig <- subset_taxa(subset_samples(v_h_phyloseq_rel_renamed, sample_type == "Nasal"),
                                       taxa_names(subset_samples(v_h_phyloseq_rel_renamed,
                                                                 sample_type == "Nasal")) %in%
                                   filt_fit_data_ns$data$feature)

filt_fit_data_ns$rel <- cbind(filt_ns_sig %>% otu_table %>% t, filt_ns_sig %>% sample_data) %>% group_by(treatment) %>% summarise_if(is.numeric, mean, na.rm = TRUE) %>% .[, 1:21] %>% column_to_rownames(., "treatment") %>% t () %>% species_italic() %>%  data.frame(check.names = F) %>% 
        .[row.names(filt_fit_data_ns$data_italic),] %>%  mutate_all(~na_if(., 0)) %>% rownames_to_column("feature")

filt_bal_sig <- subset_taxa(subset_samples(v_h_phyloseq_rel_renamed, sample_type == "BAL"),
                                       taxa_names(subset_samples(v_h_phyloseq_rel_renamed, sample_type == "BAL")) %in% filt_fit_data_bal$data$feature)

filt_fit_data_bal$rel <- cbind(filt_bal_sig %>% otu_table %>% t, filt_bal_sig %>% sample_data) %>% group_by(treatment) %>% summarise_if(is.numeric, mean, na.rm = TRUE) %>% .[, 1:21] %>% column_to_rownames(., "treatment") %>% t () %>% species_italic() %>%  data.frame(check.names = F) %>%
        .[row.names(filt_fit_data_bal$data_italic),] %>%
        mutate_all(~na_if(., 0)) %>% rownames_to_column("feature") %>% subset(., !grepl("NA", .$feature))

#filt_fit_data_bal$rel$feature <- gsub("", "", filt_fit_data_bal$rel$feature )
```


```{r}



species_italic <- function(data) {
  names <- gsub("_A|_B", "", data)
  names <- ifelse(grepl("~", names), paste("italic('", gsub("~" , "')~", names),   sep = ""),
                  paste("italic('", names, "')", sep = ""))
  names <- ifelse(grepl("\\d", names),
                  names %>% gsub("[italic(']", "", .) %>% gsub("[')]", "", .),
                  names)
  names
}

filt_maaslin_all_v_h$group <-  ifelse(filt_maaslin_all_v_h$Estimate > 0 & filt_maaslin_all_v_h$qval < 0.1, "more",
                     ifelse(filt_maaslin_all_v_h$Estimate < 0 & filt_maaslin_all_v_h$qval < 0.1, "less",
                            "insignificant"))

#Volcano plot

figS7_host <- filt_maaslin_all_v_h %>% 
        mutate(feature = species_italic(feature),
                            feature = case_when(value == "Nasal"~ NA,
                                              value == "BAL"~ NA,
                                              value == "Sputum"~ NA,
                                              qval > 0.1 ~ NA,
                                              #abs(Estimate) < 0.3 ~ NA,
                                              .default = feature),
                            label1 = case_when(group == "more" ~ feature,
                                                       .default = NA),
                            label2 = case_when(group == "less" ~ feature,
                                                       .default = NA)
                            ) %>%
        ggplot(., aes(y = -log10(qval), x = Estimate, col = metadata)) +
        theme_classic(base_family = "sans") +
        #labs(tag = "A") +
        geom_point(size = 2, alpha = 0.7, stroke = 0) +
        xlab("Change estimate of CLR-normalized RPKM") +
        ylab("-log<sub>10</sub>(*q*-value)") +
        ylim(c(-1, 6)) +
        xlim(c(-7, 8)) +
        geom_hline(yintercept = 1, col = "gray") +
        geom_vline(xintercept = 0, col = "gray") +
        labs(tag = "B")  +
        ggtitle("Viral host genus") +
        theme(legend.position = "top", axis.title.y = ggtext::element_markdown(), legend.text = element_markdown()) +
        scale_color_manual(values = c("#a65628",
                                      "grey",
                                      "#fb9a99",
                                      "#33a02c",
                                      "#b2df8a",
                                      "#1f78b4",
                                      "#a6cee3"),
                           breaks = c("log10.Final_reads",
                                      "sample_type",
                                      "lypma",
                                      "benzonase",
                                      "host_zero",
                                      "molysis",
                                      "qiaamp"), 
                           labels = c("log<sub>10</sub>(Final reads)",
                                      "Sample type",
                                      "lyPMA",
                                      "Benzonase",
                                      "HostZERO",
                                      "MolYsis",
                                      "QIAamp")) + #color using https://colorbrewer2.org/#type=qualitative&scheme=Set1&n=6
        guides(col = guide_legend(title = "Factors", title.position = "top", nrow = 1)) +
                ggrepel::geom_text_repel(aes(label = label1),
                                  point.padding = unit(0.5, "lines"),
                                  #nudge_y = 10, box.padding = unit(0.35, "lines"),
                                  na.rm = T,
                                  parse = T,
                                  max.overlaps = 34,
                                  grob = "richtext",
                                  show.legend = F,
                                  size=3, segment.size=0.25, nudge_x=5, direction="y") +
        ggrepel::geom_text_repel(aes(label = label2),
                                   box.padding = unit(0.35, "lines"),
                                  #point.padding = unit(0.5, "lines"),
                                  na.rm = T,
                                  parse = T,
                                  max.overlaps = 34,
                                  grob = "richtext",
                                  show.legend = F,
                                  #hjust=0,
                                  size=3,
                                  segment.size=0.25,
                                  nudge_x=-5,
                                  nudge_y = 2,
                                  direction="y")

figS7_host

```


### Microbial file wrangling 

```{r}
setwd("Project_SICAS2_microbiome/5_Scripts/MGK/Host_depletion_git")
phyloseq_unfiltered <- read_rds("/Volumes/macdrive/Dropbox/Project_SICAS2_microbiome/4_Data/2_Tidy/Phyloseq/PHY_20230521_MGK_host_tidy.rds")
phyloseq <- phyloseq_unfiltered
filt_maaslin_all <- read.csv("data/da_lmer_filt_maaslin_all.csv")

#filt_maaslin_interaction <- read.csv("data/da_lmer_filt_maaslin_interaction.csv")
filt_fit_data_bal_m <- read.csv("data/da_lmer_filt_fit_data_bal.csv")
filt_fit_data_spt_m <- read.csv("data/da_lmer_filt_fit_data_spt.csv")
filt_fit_data_ns_m <- read.csv("data/da_lmer_filt_fit_data_ns.csv")
#filt_fit_data_pos <- read.csv("data/da_lmer_filt_fit_data_pos.csv")
#Stratified by sample type


alpha_diversity <- function(data) {
        otu_table <- otu_table(data) %>% .[, colSums(.) !=0]
        S.obs <- rowSums(t(otu_table) != 0)
        sample_data <- sample_data(data)
        data_evenness <- vegan::diversity(t(otu_table)) / log(vegan::specnumber(t(otu_table))) # calculate evenness index using vegan package
        data_shannon <- vegan::diversity(t(otu_table), index = "shannon") # calculate Shannon index using vegan package
        data_hill <- exp(data_shannon)                           # calculate Hills index
        data_dominance <- microbiome::dominance(otu_table, index = "all", rank = 1, aggregate = TRUE) # dominance (Berger-Parker index), etc.
        data_invsimpson <- vegan::diversity(t(otu_table), index = "invsimpson")                          # calculate Shannon index using vegan package
        alpha_diversity <- cbind(S.obs, data_shannon, data_hill, data_invsimpson, data_evenness,data_dominance) # combine all indices in one data table
        sample_data <- merge(data.frame(sample_data), alpha_diversity, by = 0, all = T) %>% column_to_rownames(var = "Row.names")
}
phyloseq <- phyloseq_unfiltered

sample_data(phyloseq_unfiltered$phyloseq_rel) <- sample_data(alpha_diversity(phyloseq_unfiltered$phyloseq_rel))
sample_data(phyloseq_unfiltered$phyloseq_count) <- sample_data(alpha_diversity(phyloseq_unfiltered$phyloseq_count)) 
sample_data(phyloseq_unfiltered$phyloseq_path_rpk) <- sample_data(alpha_diversity(phyloseq_unfiltered$phyloseq_path_rpk))  



prev_neg <- ((phyloseq_unfiltered$phyloseq_count %>% 
          subset_samples(sample_type == "Neg.") %>%
          otu_table %>% 
          data.frame(.)) != 0) %>%
        rowSums %>% data.frame %>% rename("Prevalence (negative controls)" = ".")

prev_all <- ((phyloseq_unfiltered$phyloseq_count %>%
                      subset_samples(sample_type != "Mock") %>%
                      subset_samples(sample_type != "Neg.") %>%
          otu_table %>% 
          data.frame(.)) != 0) %>%
        rowSums %>% data.frame %>% rename("Prevalence (all)" = ".")




sample_data(phyloseq_unfiltered$phyloseq_rel)$is.neg <- grepl("Neg", sample_data(phyloseq_unfiltered$phyloseq_rel)$sample_type)



phyloseq_decontam_lypma <- phyloseq_unfiltered$phyloseq_rel %>% 
        subset_samples(S.obs != 0) %>%
        subset_samples(treatment == "Untreated" | treatment == "lyPMA")

phyloseq_decontam_ben <- phyloseq_unfiltered$phyloseq_rel %>% 
        subset_samples(S.obs != 0) %>%
        subset_samples(treatment == "Untreated" | treatment == "Benzonase")

phyloseq_decontam_hostzero <- phyloseq_unfiltered$phyloseq_rel %>% 
        subset_samples(S.obs != 0) %>%
        subset_samples(treatment == "Untreated" | treatment == "HostZero")

phyloseq_decontam_molysis <- phyloseq_unfiltered$phyloseq_rel %>% 
        subset_samples(S.obs != 0) %>%
        subset_samples(treatment == "Untreated" | treatment == "MolYsis")

phyloseq_decontam_qiaamp <- phyloseq_unfiltered$phyloseq_rel %>% 
        subset_samples(S.obs != 0) %>%
        subset_samples(treatment == "Untreated" | treatment == "QIAamp")


contaminant_combined_lypma <- 
data.frame("lyPMA", fix.empty.names = F, 
        isContaminant(phyloseq_decontam_lypma, method="combined", neg = "is.neg", threshold = 0.1, conc = "DNA_bac_ng_uL") %>% subset(.,.$contaminant) %>% row.names
)

contaminant_combined_ben <- 
data.frame("Benzonase", fix.empty.names = F, 
        isContaminant(phyloseq_decontam_ben, method="combined", neg = "is.neg", threshold = 0.1, conc = "DNA_bac_ng_uL") %>% subset(.,.$contaminant) %>% row.names
)


contaminant_combined_hostzero <- 
data.frame("HostZero", fix.empty.names = F, 
        isContaminant(phyloseq_decontam_hostzero, method="combined", neg = "is.neg", threshold = 0.1, conc = "DNA_bac_ng_uL") %>% subset(.,.$contaminant) %>% row.names
)


contaminant_combined_molysis <- 
data.frame("MolYsis", fix.empty.names = F, 
        isContaminant(phyloseq_decontam_molysis, method="combined", neg = "is.neg", threshold = 0.1, conc = "DNA_bac_ng_uL") %>% subset(.,.$contaminant) %>% row.names
)


contaminant_combined_QIAamp <- 
data.frame("QIAamp", fix.empty.names = F, 
        isContaminant(phyloseq_decontam_qiaamp, method="combined", neg = "is.neg", threshold = 0.1, conc = "DNA_bac_ng_uL") %>% subset(.,.$contaminant) %>% row.names
)

contaminants_strat_treat <- rbind(contaminant_combined_lypma,
                      contaminant_combined_ben, 
                      contaminant_combined_hostzero,
                      contaminant_combined_molysis,
                      contaminant_combined_QIAamp
                      )

names(contaminants_strat_treat) <- c("Treatment", "Taxa")

phyloseq_unfiltered$phyloseq_rel <- transform_sample_counts(phyloseq_unfiltered$phyloseq_rel,
                                                            function(x){x/sum(x)})
taxa_qc <- data.frame("species" =
                              otu_table(
                                      subset_samples(
                                              phyloseq_unfiltered$phyloseq_rel,S.obs != 0 &
                                                      sample_type %in% c("Mock", "BAL", "Nasal", "Sputum"))) %>%
                              t() %>% colnames(),
                      "prevalence" =
                              ifelse(subset_samples(phyloseq_unfiltered$phyloseq_rel, S.obs != 0 & 
                                                            sample_type %in% c("Mock", "BAL", "Nasal", "Sputum")) %>%
                                             otu_table() > 0, 1, 0)%>% 
                              t() %>%
                              colSums(), #Prevalence of taxa
                      "mean_rel_abd" = 
                              subset_samples(phyloseq_unfiltered$phyloseq_rel,
                                             S.obs != 0 & sample_type %in% c("Mock", "BAL", "Nasal", "Sputum")) %>%
                              otu_table() %>%
                              t() %>%
                              colMeans(na.rm = T) #mean relativ abundacne 
)


function_qc <- data.frame("function" =
                                  otu_table(
                                          subset_samples(
                                                  phyloseq_unfiltered$phyloseq_path_rpk,
                                                           S.obs != 0 & 
                                                          sample_type %in% 
                                                          c("Mock", "BAL", "Nasal", "Sputum")
                                                  )
                                          ) %>% 
                                  t() %>% 
                                  colnames(),
                          "prevalence" = 
                                  ifelse(subset_samples(phyloseq_unfiltered$phyloseq_path_rpk,
                                                        S.obs != 0 & 
                                                                sample_type %in% 
                                                                c("Mock", "BAL", "Nasal", "Sputum")
                                                        ) %>% 
                                                 otu_table() > 0, 
                                         1, 
                                         0
                                         ) %>% 
                                  t() %>% 
                                  colSums(), #Prevalence of taxa
                          "mean_rpk" = 
                                  subset_samples(phyloseq_unfiltered$phyloseq_path_rpk, 
                                                 S.obs != 0 & 
                                                         sample_type %in% 
                                                         c("Mock", "BAL", "Nasal", "Sputum")
                                                 ) %>% 
                                  otu_table() %>% 
                                  t() %>% 
                                  colMeans(na.rm = T), #mean relativ abundacne 
                          unidentified = 
                                  ifelse((subset_samples(phyloseq_unfiltered$phyloseq_path_rpk,
                                              S.obs != 0 & sample_type %in% c("Mock", "BAL", "Nasal", "Sputum")) %>% 
                                       otu_table() > 0) %>%
                                      row.names() %in% c("UNMAPPED", "UNINTEGRATED")
                              , 1, 0)
)

red_flag_taxa <- data.frame(species = taxa_qc$species,
                            prevalence = taxa_qc$prevalence,
                            mean_rel_abd = taxa_qc$mean_rel_abd,
                            red_flag_prev_abd = 
                                    ifelse(taxa_qc$prevalence < 
                                                   otu_table(
                                                           subset_samples(
                                                                   phyloseq_unfiltered$phyloseq_rel,
                                                                   S.obs != 0 & 
                                                                           sample_type %in% 
                                                                           c("Mock", "BAL", "Nasal", "Sputum"))) %>%
                                                               t %>% rownames() %>%
                                                   length * 0.05 &
                                                   #Removing taxa with zero prevalence - taxa from nasal swabs
                                                   taxa_qc$mean_rel_abd <
                                                   taxa_qc %>%
                                                   subset(., .$prevalence != 0) %>%
                                                   .$mean_rel_abd %>%
                                                   quantile(., 0.75), 1,0),
                           red_flag_prev =
                                    ifelse(taxa_qc$prevalence < 
                                                   otu_table(
                                                           subset_samples(
                                                                   phyloseq_unfiltered$phyloseq_rel,
                                                                   S.obs != 0 & 
                                                                           sample_type %in% 
                                                                           c("Mock", "BAL", "Nasal", "Sputum"))) %>%
                                                               t %>% rownames() %>%
                                                   length * 0.05,
                                           1,
                                           0)) %>%
        mutate(red_flag_decontam = species %in% (contaminants$Taxa %>% unique()))

subset(red_flag_taxa, red_flag_taxa$red_flag_prev == 1 & red_flag_taxa$red_flag_prev_abd == 0)

#Unampped function were removed

red_flag_function <- 
        data.frame(function. = function_qc$function.,
                   prevalence = function_qc$prevalence,
                   mean_rel_abd = function_qc$mean_rpk,
                   red_flag_prev_abd = 
                           ifelse(function_qc$prevalence < 
                                          otu_table(
                                                  subset_samples(
                                                          phyloseq_unfiltered$phyloseq_path_rpk,
                                                          S.obs != 0 & 
                                                                  sample_type %in% 
                                                                  c("Mock", "BAL", "Nasal", "Sputum"))) %>%
                                          t %>% 
                                          rownames() %>%
                                          length * 0.05 &
                                          #Removing taxa with zero prevalence - taxa from nasal swabs
                                          function_qc$mean_rpk <
                                          function_qc %>%
                                          subset(., .$prevalence != 0) %>%
                                          .$mean_rpk %>%
                                          quantile(., 0.75), 1,0),
                   red_flag_prev =
                           ifelse(function_qc$prevalence <
                                          otu_table(
                                                  subset_samples(
                                                          phyloseq_unfiltered$phyloseq_path_rpk,
                                                          S.obs != 0 & 
                                                                  sample_type %in% 
                                                                  c("Mock", "BAL", "Nasal", "Sputum"))) %>%
                                          t %>% 
                                          rownames() %>%
                                          length * 0.05,
                                          1,
                                          0)) %>%
        mutate(red_flag_prev_abd = case_when(function. %in% c("UNMAPPED", "UNINTEGRATED") ~ 1,
                                     .default = red_flag_prev_abd))

subset(red_flag_function, red_flag_function$red_flag_prev == 1 & red_flag_function$red_flag_prev_abd == 0)



#decontaminated phyloseq 
phyloseq_decontam <- phyloseq
phyloseq_decontam$phyloseq_count <- prune_taxa(subset(red_flag_taxa,
                                           red_flag_taxa$red_flag_prev_abd != 1 &
                                                   !red_flag_taxa$red_flag_decontam)$species,
                                    phyloseq$phyloseq_count)

phyloseq_decontam$phyloseq_rel <- prune_taxa(subset(red_flag_taxa,
                                           red_flag_taxa$red_flag_prev_abd != 1 &
                                                   !red_flag_taxa$red_flag_decontam)$species,
                                    phyloseq$phyloseq_rel) %>%
        transform_sample_counts(., function(x){x/sum(x)})
        
#phyloseq for analysis
phyloseq$phyloseq_count <- prune_taxa(subset(red_flag_taxa,
                                           red_flag_taxa$red_flag_prev_abd != 1)$species,
                                    phyloseq$phyloseq_count)
phyloseq$phyloseq_rel <- prune_taxa(subset(red_flag_taxa,
                                           red_flag_taxa$red_flag_prev_abd != 1)$species,
                                    phyloseq$phyloseq_rel) %>%
        transform_sample_counts(., function(x){x/sum(x)})


phyloseq$phyloseq_path_rpk <- prune_taxa(subset(red_flag_function, red_flag_function$red_flag_prev_abd != 1)$function., phyloseq$phyloseq_path_rpk)

#Calculation of alpha diversity indices for filtered samples

alpha_diversity <- function(data) {
        otu_table <- otu_table(data) %>% .[, colSums(.) !=0]
        S.obs <- rowSums(t(otu_table) != 0)
        sample_data <- sample_data(data)
        data_evenness <- vegan::diversity(t(otu_table)) / log(vegan::specnumber(t(otu_table))) # calculate evenness index using vegan package
        data_shannon <- vegan::diversity(t(otu_table), index = "shannon") # calculate Shannon index using vegan package
        data_hill <- exp(data_shannon)                           # calculate Hills index
        data_dominance <- microbiome::dominance(otu_table, index = "all", rank = 1, aggregate = TRUE) # dominance (Berger-Parker index), etc.
        data_invsimpson <- vegan::diversity(t(otu_table), index = "invsimpson")                          # calculate Shannon index using vegan package
        alpha_diversity <- cbind(S.obs, data_shannon, data_hill, data_invsimpson, data_evenness,data_dominance) # combine all indices in one data table
        sample_data <- merge(data.frame(sample_data), alpha_diversity, by = 0, all = T) %>% column_to_rownames(var = "Row.names")
}
#sample_data(phyloseq$phyloseq_count) <- sample_data(alpha_diversity(phyloseq$phyloseq_count))
sample_data(phyloseq$phyloseq_rel) <- sample_data(alpha_diversity(phyloseq$phyloseq_count))
sample_data(phyloseq$phyloseq_count) <-sample_data(alpha_diversity(phyloseq$phyloseq_count)) 
sample_data(phyloseq$phyloseq_path_rpk) <- sample_data(alpha_diversity(phyloseq$phyloseq_path_rpk))  

sample_data(phyloseq_decontam$phyloseq_rel) <- sample_data(alpha_diversity(phyloseq_decontam$phyloseq_count))  
sample_data(phyloseq_decontam$phyloseq_count) <- sample_data(alpha_diversity(phyloseq_decontam$phyloseq_count))

sample_data <- sample_data(phyloseq$phyloseq_count)

```



### Updated volcano plot

```{r}

species_italic <- function(data) {
  names <- gsub("_", "~", data)
  names <- gsub("[]]|[[]", "", names)
  names <- gsub("X.Collinsella.", "Collinsella", names)
  names <- gsub("~sp", "')~'sp.'", names)
  names <- gsub(" group", "", names)
  names <- ifelse(grepl("')", names), paste("italic('", names, sep = ""),
                  paste("italic('", names, "')", sep = ""))
  names <- ifelse(grepl("sp[.]", names), names,
                  gsub("~", " ", names))
    names
}

species_italic(filt_maaslin_all$feature)
# Example usage
filt_maaslin_all$italic <- species_italic(filt_maaslin_all$feature)


filt_maaslin_all$group <-  ifelse(filt_maaslin_all$Estimate > 1 & filt_maaslin_all$qval < 0.001, "more",
                     ifelse(filt_maaslin_all$Estimate < 1 & filt_maaslin_all$qval < 0.001, "less",
                            "insignificant"))

figS7 <- filt_maaslin_all %>% mutate(feature = species_italic(feature),
                            feature = case_when(value == "Nasal"~ NA,
                                              value == "BAL"~ NA,
                                              value == "Sputum"~ NA,
                                              qval > 0.01 ~ NA,
                                              abs(Estimate) < 2 ~ NA,
                                              .default = feature),
                            label1 = case_when(group == "more" ~ feature,
                                                       .default = NA),
                            label2 = case_when(group == "less" ~ feature,
                                                       .default = NA)
                            ) %>%
        ggplot(., aes(y = -log10(qval), x = Estimate, col = metadata)) +
        theme_classic(base_family = "sans") +
        #labs(tag = "A") +
        geom_point(size = 2, alpha = 0.7, stroke = 0) +
        xlab("Change estimate of CLR-normalized read counts") +
        ylab("-log<sub>10</sub>(*q*-value)") +
        ylim(c(-1, 25)) +
        xlim(c(-20, 22)) +
        geom_hline(yintercept = 1, col = "gray") +
        geom_vline(xintercept = 0, col = "gray") +
        ggtitle("A   Microbial species") +
        #annotate(family = "sans",
        #         geom='richtext',
        #         x=0, y=7,
        #         label = "<i>q</i>-value = 0.1, fold-change = 0") +
        theme(legend.position = "top", axis.title.y = ggtext::element_markdown(), legend.text = element_markdown()) +
        scale_color_manual(values = c("#a65628",
                                      "grey",
                                      "#fb9a99",
                                      "#33a02c",
                                      "#b2df8a",
                                      "#1f78b4",
                                      "#a6cee3"),
                           breaks = c("log10.Final_reads",
                                      "sample_type",
                                      "lypma",
                                      "benzonase",
                                      "host_zero",
                                      "molysis",
                                      "qiaamp"), 
                           labels = c("log<sub>10</sub>(Final reads)",
                                      "Sample type",
                                      "lyPMA",
                                      "Benzonase",
                                      "HostZERO",
                                      "MolYsis",
                                      "QIAamp")) + #color using https://colorbrewer2.org/#type=qualitative&scheme=Set1&n=6
        guides(col = guide_legend(title = "Factors", title.position = "top", nrow = 1)) +
        ggrepel::geom_text_repel(aes(label = label1),
                                  point.padding = unit(0.5, "lines"),
                                  #nudge_y = 10, box.padding = unit(0.35, "lines"),
                                  na.rm = T,
                                  parse = T,
                                  max.overlaps = 34,
                                  grob = "richtext",
                                  show.legend = F,
                                 
                                 segment.size=0.25,
                                 nudge_x=15,
                                 #nudge_y=10,
                                 direction="y") +
        ggrepel::geom_text_repel(aes(label = label2),
                                   box.padding = unit(0.5, "lines"),
                                  #point.padding = unit(0.5, "lines"),
                                  na.rm = T,
                                  parse = T,
                                  max.overlaps = 34,
                                  grob = "richtext",
                                  show.legend = F,
                                  #hjust=0,
                                  size=4,
                                  segment.size=0.25,
                                  nudge_x=-15,
                                  #nudge_y = 5,
                                  direction="y")
        
figS7
```


```{r}


filt_maaslin_all_v_h$group <-  ifelse(filt_maaslin_all_v_h$Estimate > 1 & filt_maaslin_all_v_h$qval < 0.1, "more",
                     ifelse(filt_maaslin_all_v_h$Estimate < (-1) & filt_maaslin_all_v_h$qval < 0.1, "less",
                            "insignificant"))

figS7_host <- filt_maaslin_all_v_h %>% 
        mutate(feature = species_italic(feature),
                            feature = case_when(value == "Nasal"~ NA,
                                              value == "BAL"~ NA,
                                              value == "Sputum"~ NA,
                                              qval > 0.1 ~ NA,
                                              #abs(Estimate) < 0.3 ~ NA,
                                              .default = feature),
                            label1 = case_when(group == "more" ~ feature,
                                                       .default = NA),
                            label2 = case_when(group == "less" ~ feature,
                                                       .default = NA)
                            ) %>%
        ggplot(., aes(y = -log10(qval), x = Estimate, col = metadata)) +
        theme_classic(base_family = "sans") +
        #labs(tag = "A") +
        geom_point(size = 2, alpha = 0.7, stroke = 0) +
        xlab("Change estimate of CLR-normalized RPKM") +
        ylab("-log<sub>10</sub>(*q*-value)") +
        ylim(c(-1, 6)) +
        xlim(c(-7, 8)) +
        geom_hline(yintercept = 1, col = "gray") +
        geom_vline(xintercept = 0, col = "gray") +
        ggtitle("B   Viral host genus") +
        theme(legend.position = "top", axis.title.y = ggtext::element_markdown(), legend.text = element_markdown()) +
        scale_color_manual(values = c("#a65628",
                                      "grey",
                                      "#fb9a99",
                                      "#33a02c",
                                      "#b2df8a",
                                      "#1f78b4",
                                      "#a6cee3"),
                           breaks = c("log10.Final_reads",
                                      "sample_type",
                                      "lypma",
                                      "benzonase",
                                      "host_zero",
                                      "molysis",
                                      "qiaamp"), 
                           labels = c("log<sub>10</sub>(Final reads)",
                                      "Sample type",
                                      "lyPMA",
                                      "Benzonase",
                                      "HostZERO",
                                      "MolYsis",
                                      "QIAamp")) + #color using https://colorbrewer2.org/#type=qualitative&scheme=Set1&n=6
        guides(col = guide_legend(title = "Factors", title.position = "top", nrow = 1)) +
        ggrepel::geom_text_repel(aes(label = label1),
                                  point.padding = unit(0.5, "lines"),
                                  #nudge_y = 10, box.padding = unit(0.35, "lines"),
                                 na.rm = T,
                                 parse = T,
                                 max.overlaps = 10,
                                 grob = "richtext",
                                 show.legend = F,
                                 #size=4, 
                                 segment.size=0.25, 
                                 hjust="left",
                                 nudge_x=4,
                                 #nudge_y = 2,
                                 direction="y") +
        ggrepel::geom_text_repel(aes(label = label2),
                                   box.padding = unit(0.35, "lines"),
                                  #point.padding = unit(0.5, "lines"),
                                 na.rm = T,
                                 parse = T,
                                 max.overlaps = 34,
                                 grob = "richtext",
                                 show.legend = F,
                                 #hjust=0,
                                 #size=4,
                                 segment.size=0.25,
                                 nudge_x=-4,
                                 #nudge_y = 2,
                                 direction="y") 
figS7_host

```


### Creating figures for ATS poster..




```{r}



pdf(file = "Project_SICAS2_microbiome/7_Manuscripts/2022_MGK_Host_Depletion/Figures/Figure4_updated_small2.pdf",   # The directory you want to save the file in
    width = 8.66, # The width of the plot in inches
    height = 5.72 # The height of the plot in inches
) #fixing multiple page issue

ggarrange(figS7, figS7_host,
          legend = "none",ncol = 1,align = "hv")

# alpha diversity plots
#ggarrange(f4ad, ggarrange(f4e, f4f, ncol = 2),
#          ncol = 1) # alpha diversity plots

dev.off()




pdf(file = "Project_SICAS2_microbiome/7_Manuscripts/2022_MGK_Host_Depletion/Figures/Figure4_updated_small.pdf",   # The directory you want to save the file in
    width = 8.66, # The width of the plot in inches
    height = 4.72 # The height of the plot in inches
) #fixing multiple page issue

ggarrange(figS7, figS7_host,
          legend = "none",ncol = 1,align = "hv")

# alpha diversity plots
#ggarrange(f4ad, ggarrange(f4e, f4f, ncol = 2),
#          ncol = 1) # alpha diversity plots

dev.off()



png(file = "Project_SICAS2_microbiome/7_Manuscripts/2022_MGK_Host_Depletion/Figures/Figure4_updated_small.png",   # The directory you want to save the file in
    width = 220, # The width of the plot in inches
    height = 120, # The height of the plot in inches
    units = "mm",
    res = 600
) #fixing multiple page issue

ggarrange(figS7, figS7_host,
          legend = "none",ncol = 1,align = "hv")

# alpha diversity plots
#ggarrange(f4ad, ggarrange(f4e, f4f, ncol = 2),
#          ncol = 1) # alpha diversity plots

dev.off()

png(file = "Project_SICAS2_microbiome/7_Manuscripts/2022_MGK_Host_Depletion/Figures/Figure4_updated_small2.png",   # The directory you want to save the file in
    width = 180, # The width of the plot in inches
    height = 120, # The height of the plot in inches
    units = "mm",
    res = 600
) #fixing multiple page issue


ggarrange(figS7, figS7_host,
          legend = "none",ncol = 2,align = "hv")

# alpha diversity plots
#ggarrange(f4ad, ggarrange(f4e, f4f, ncol = 2),
#          ncol = 1) # alpha diversity plots

dev.off()

```

### {-}

Done.

# Bibliography

```{r warning=FALSE}
#===============================================================================
#BTC.LineZero.Footer.1.1.0
#===============================================================================
#R markdown citation generator.
#===============================================================================
#RLB.Dependencies:
#   magrittr, pacman, stringr
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
#BTC.Dependencies:
#   LineZero.Header
#===============================================================================
#Generates citations for each explicitly loaded library.
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
str_libraries <- c("r", str_libraries)
for (str_libraries in str_libraries) {
    str_libraries |>
        pacman::p_citation() |>
        print(bibtex = FALSE) |>
        capture.output() %>%
        .[-1:-3] %>% .[. != ""] |>
        stringr::str_squish() |>
        stringr::str_replace("_", "") |>
        cat()
    cat("\n")
}
#===============================================================================
```
