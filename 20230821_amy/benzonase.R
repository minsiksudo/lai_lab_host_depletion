###### Amy Willis, August 21 2023
###### benzonase

## Steps
## 1. set up data
## 2. rerun tinyvamp
## 3. save


######## Step 1

library(dplyr)
library(tibble)
library(magrittr)
library(phyloseq)
library(tinyvamp)
ps <- readRDS("../data/PHY_20230521_MGK_host_tidy.rds")
ps_benzonase_genus <- ps$phyloseq_count %>% 
  tax_glom("Genus") %>%
  phyloseq::subset_samples(treatment == "Benzonase")  %>%
  phyloseq::prune_taxa(taxa_sums(.) > 0, .)
ps_benzonase_genus
zero_counts <- which(ps_benzonase_genus %>% sample_sums() == 0) %>% names
ps_benzonase_genus <- ps_benzonase_genus %>%
  phyloseq::subset_samples(!(baylor_other_id %in% zero_counts)) %>% # has zero reads
  phyloseq::prune_taxa(taxa_sums(.) > 0, .) 
W <- ps_benzonase_genus %>% otu_table %>% as.matrix %>% t
jj <- ncol(W) 
nn <- nrow(W) 
sample_ids <- ps_benzonase_genus %>% sample_data %>% as_tibble %>% pull(sample_id)
subject_ids <- ps_benzonase_genus %>% sample_data %>% as_tibble %>% pull(subject_id)
treatment_ids <- ps_benzonase_genus %>% sample_data %>% as_tibble %>% pull(treatment)
specimen_ids <- paste(subject_ids, treatment_ids, sep = "_")
sample_specimen_map <- tibble(sample_ids, specimen_ids)
KK <- specimen_ids %>% unique %>% length
Z <- matrix(0, nrow = nn, ncol = KK)
rownames(Z) <- sample_ids
colnames(Z) <- unique(specimen_ids) 
for (i in 1:nn) {
  Z[i, sample_specimen_map[i, 2] %>% unlist] <- 1
}

stopifnot(all(apply(Z, 1, sum) == 1))


ps_benzonase_genus %>% 
  subset_samples(subject_id == "Mock") %>%
  taxa_sums() %>% sort %>% tail(10)


P <- matrix(0, nrow = KK, ncol = jj)
rownames(P) <- unique(specimen_ids)
colnames(P) <- ps_benzonase_genus %>% otu_table %>% rownames
P <- ((t(Z) %*% W ) / (t(Z) %*% W %>% apply(1, sum)))
mock_samples <- which((rownames(P) %>% substr(1, 4)) == "Mock")
neg_samples <- which((rownames(P) %>% substr(1, 4)) == "Neg.")
##########################################
##### this is the line that I needed to fix
##########################################
P[mock_samples, ] <- 0 
P[mock_samples, "Listeria_monocytogenes"] <- 0.12
P[mock_samples, "Pseudomonas_aeruginosa_group"] <- 0.12
P[mock_samples, "Bacillus_intestinalis"] <- 0.12 ## note misclassification
P[mock_samples, "Escherichia_coli"] <- 0.12 
P[mock_samples, "Salmonella_enterica"] <- 0.12 
P[mock_samples, "Lactobacillus_fermentum"] <- 0.12 
P[mock_samples, "Enterococcus_faecalis"] <- 0.12 
P[mock_samples, "Staphylococcus_aureus"] <- 0.12 
P[mock_samples, "Saccharomyces_cerevisiae"] <- 0.02 
P[mock_samples, "Cryptococcus_neoformans"] <- 0.02 
P[neg_samples, ] <- 0

P[mock_samples, ] %>% sum ### checked

P_fixed_indices <- matrix(FALSE, nrow = KK, ncol = jj)
rownames(P_fixed_indices) <- unique(specimen_ids)
colnames(P_fixed_indices) <- colnames(W)
P_fixed_indices[mock_samples, ] <- TRUE
P_fixed_indices[neg_samples, ] <- TRUE

old_bhats <- c(Staphylococcus_aureus = -0.365, Escherichia_coli = 0.478, 
               Pseudomonas_aeruginosa_group = -0.765, 
               Lactobacillus_fermentum = 0.136, Bacillus_intestinalis = 0.3, 
               Listeria_monocytogenes = -0.006, Salmonella_enterica = 0.388, 
               Saccharomyces_cerevisiae = 0.091, Cryptococcus_neoformans = -0.269)
tmts <- treatment_ids %>% unique
pp <- tmts %>% length # 1
B <- matrix(0, nrow = pp, ncol = jj)
colnames(B) <- colnames(W)
rownames(B) <- tmts
B[, names(old_bhats)] <- matrix(old_bhats, nrow = pp, ncol = length(old_bhats),
                                byrow = T)

B_fixed_indices <- matrix(TRUE, nrow = pp, ncol = jj) ## in general, don't estimate efficiencies...
colnames(B_fixed_indices) <- colnames(W)
rownames(B_fixed_indices) <- tmts
B_fixed_indices[, c("Listeria_monocytogenes", "Pseudomonas_aeruginosa_group", 
                    "Bacillus_intestinalis", "Escherichia_coli", 
                    "Salmonella_enterica", "Lactobacillus_fermentum", 
                    "Enterococcus_faecalis", "Staphylococcus_aureus", 
                    "Saccharomyces_cerevisiae", "Cryptococcus_neoformans")] <- FALSE
B_fixed_indices[, "Enterococcus_faecalis"] <- TRUE

X <- matrix(1, nrow = nn, ncol = pp)
gammas_fixed_indices <- rep(FALSE, nn)
gammas <- log(apply(W, 1, sum)) + rnorm(nn)

KK_tilde <- pp
P_tilde <- matrix(0, ncol = jj, nrow = KK_tilde)
P_tilde_fixed_indices <- matrix(FALSE, ncol = jj, nrow = KK_tilde)
neg_profile <- (t(Z) %*% W)[neg_samples, ] 
P_tilde <- matrix(neg_profile / sum(neg_profile), ncol = jj, nrow = KK_tilde)


DNA_bac_ng_uLs <- ps_benzonase_genus %>% sample_data %>% as_tibble %>% pull(DNA_bac_ng_uL)
Zis <- 1/DNA_bac_ng_uLs
Z_tilde <- matrix(0, nrow = nn, ncol = KK_tilde)
rownames(Z_tilde) <- rownames(Z)
colnames(Z_tilde) <- tmts
specimen_treatment_map <- tibble(specimen_ids, treatment_ids) %>% 
  mutate(treatment_ids = as.character(treatment_ids))
for (i in 1:nn) {
  Z_tilde[i, specimen_treatment_map[i, "treatment_ids"] %>% unlist] <- Zis[i]/exp(mean(log(Zis)))
}

Z_tilde_gamma_cols <- 1

gamma_tilde <- matrix(0, nrow = KK_tilde, ncol = 1)
gamma_tilde_fixed_indices <- matrix(FALSE, nrow = KK_tilde, ncol = 1)

X_tilde <- matrix(0, nrow = KK_tilde, ncol = pp) 

### These initializations come from previous optimization runs and are provided here for reproducibility
P_start <- structure(c(5.56650802706751e-16, 4.58461819380602e-16, 5.49015727809344e-17, 
                       1.38518744289373e-15, 2.28485023047065e-16, 7.15891730468404e-08, 
                       1.05027812343624e-18, 6.480347222886e-08, 4.07018939706434e-20, 
                       7.56446285239923e-20, 3.07605469511996e-15, 2.71757532878996e-15, 
                       5.45699849617756e-16, 3.54820986374026e-18, 6.08304780973112e-16, 
                       0, 0, 5.57065392310302e-16, 4.58332088984851e-16, 5.47372789975358e-17, 
                       1.38330191949375e-15, 2.29720528225037e-16, 5.67843504941463e-06, 
                       8.70054634440178e-07, 1.22508071444311e-05, 2.56166484555529e-05, 
                       8.21054664178066e-05, 0.0150285895433436, 2.71631992503439e-15, 
                       5.45430107639139e-16, 3.54729362292996e-18, 0.000754389938205983, 
                       0, 0, 5.56915127531143e-16, 4.58585272728876e-16, 3.59056052946679e-05, 
                       1.38306805542798e-15, 3.92145414387292e-05, 1.44172640162403e-08, 
                       1.04951377262797e-18, 1.78215357472812e-08, 7.71568581980186e-09, 
                       2.77425995835388e-08, 3.07375175309146e-15, 2.7161059307963e-15, 
                       5.45506399999361e-16, 3.54731529560213e-18, 6.0743061755418e-16, 
                       0, 0, 5.5634436722167e-16, 4.5843909828671e-16, 5.50690392310914e-17, 
                       1.38460568154342e-15, 2.30252627293433e-16, 1.01590915856057e-08, 
                       1.05021282935781e-18, 2.18714623195222e-07, 4.00644130366003e-08, 
                       7.55687655745681e-20, 3.07551486526631e-15, 2.71728726806986e-15, 
                       5.45717114668821e-16, 3.54816366370307e-18, 6.07252120352378e-16, 
                       0, 0, 5.56697453795779e-16, 4.58672160480745e-16, 5.5043793470769e-17, 
                       1.38526446097286e-15, 2.30449077418893e-16, 2.44207269651144e-07, 
                       1.04999365421609e-18, 1.803021812169e-20, 6.59548254557046e-08, 
                       1.18925265600835e-07, 3.07630278429334e-15, 2.71768767321046e-15, 
                       5.45889079293605e-16, 3.548595932655e-18, 6.06885270377048e-16, 
                       0, 0, 5.55709016432342e-16, 4.58275753244488e-16, 5.47795370096154e-17, 
                       1.3827921515055e-15, 2.30323157401341e-16, 4.53916857915598e-10, 
                       1.04928767136548e-18, 7.00081971407687e-08, 2.22211751623091e-07, 
                       1.41596637304143e-07, 3.07246509229109e-15, 2.71604362851431e-15, 
                       5.45372180758108e-16, 3.54613821280745e-18, 6.07174093787663e-16, 
                       0, 0, 0.785597593278879, 0.480935719440724, 0.959387632995747, 
                       0.326373182744889, 0.569104663629153, 1.89780476855998e-08, 1.04973975781132e-18, 
                       1.80274368125247e-20, 4.06951990497055e-20, 3.58366770256904e-07, 
                       3.07503499653494e-15, 2.71722765248647e-15, 5.45828345775142e-16, 
                       3.5476475990734e-18, 6.06765610637574e-16, 0, 0, 5.53529867640059e-16, 
                       4.57472359385601e-16, 5.51847710470598e-17, 0.00127095516412094, 
                       2.28142864550597e-16, 9.82120452265245e-06, 6.94608988490062e-06, 
                       1.07860953185528e-05, 1.22831432129437e-05, 6.90313437613652e-06, 
                       0.0122870460602334, 2.71598218723672e-15, 5.45518429443402e-16, 
                       3.54727112362693e-18, 6.07343279105211e-16, 0, 0, 0.071827120788661, 
                       0.257565967762264, 0.0135042326681441, 0.219934952698647, 0.105287896921423, 
                       7.66654538459979e-21, 5.90805569982667e-19, 8.11871095890197e-21, 
                       1.82272468106379e-20, 3.48023210481468e-20, 2.35288678285683e-15, 
                       2.18530707478904e-15, 4.10356431512519e-16, 2.21609094972735e-18, 
                       5.16604201186531e-16, 0, 0, 5.53926093845071e-16, 4.57672510280806e-16, 
                       5.5361833403093e-17, 1.38615462866015e-15, 2.28491189536408e-16, 
                       1.70788991098671e-20, 1.05000352160781e-18, 1.80943230708874e-20, 
                       6.17254865574937e-09, 7.5819047894068e-20, 3.07704285143205e-15, 
                       2.71893775920509e-15, 5.46068667122076e-16, 3.54855690366363e-18, 
                       6.0673180329581e-16, 0, 0, 5.53636528978813e-16, 4.57423750206089e-16, 
                       5.52054364409852e-17, 1.38352069125561e-15, 2.28188158587941e-16, 
                       1.17153779561936e-08, 1.05007173294828e-18, 1.19894556004581e-08, 
                       1.35681763979557e-07, 4.76695420813685e-07, 3.07514784621142e-15, 
                       2.71686961569965e-15, 5.45751774111847e-16, 3.54811003187318e-18, 
                       6.06856907185194e-16, 0, 0, 5.53660927767542e-16, 4.57350257863344e-16, 
                       5.51941647439504e-17, 1.38340509839074e-15, 2.28116526841648e-16, 
                       1.75233522310258e-07, 1.04961366958525e-18, 2.99782860773974e-07, 
                       1.16506855885912e-06, 9.20089778543572e-06, 3.07506317319365e-15, 
                       0.000536208841382087, 5.45711812260878e-16, 3.5481373716002e-18, 
                       0.00172340584958504, 0, 0, 5.53641699186562e-16, 4.57230201660827e-16, 
                       5.51930319479088e-17, 1.38336458554681e-15, 2.28400223333465e-16, 
                       8.14888835693149e-09, 1.04946360143967e-18, 1.95177184178272e-09, 
                       1.58142982700762e-07, 1.63074778910848e-08, 3.07475018675702e-15, 
                       2.71665838704769e-15, 5.45701680850783e-16, 3.54779292764581e-18, 
                       6.06885154796145e-16, 0, 0, 5.53603091961064e-16, 4.5723960899009e-16, 
                       5.51993142772961e-17, 1.38331700799075e-15, 2.0575531000859e-05, 
                       6.78713778266796e-09, 1.04952691702418e-18, 3.18324693254452e-09, 
                       6.07538816805654e-08, 6.0456991208068e-08, 3.07484873872581e-15, 
                       2.71637969088835e-15, 5.45748155667851e-16, 3.54792248946013e-18, 
                       6.06284568066973e-16, 0, 0, 5.5366956685957e-16, 4.57282514631104e-16, 
                       5.52063222458864e-17, 1.38348367150955e-15, 2.28212525913362e-16, 
                       1.09804649478613e-08, 1.04986857295747e-18, 6.92414296297859e-09, 
                       3.50920821746569e-08, 6.14513496161078e-08, 3.07488713654274e-15, 
                       2.71651851704375e-15, 5.45714737164325e-16, 3.54789226129829e-18, 
                       6.06199698800751e-16, 0, 0, 5.5355742474327e-16, 4.57301623677179e-16, 
                       4.08723748998689e-06, 1.38280832311197e-15, 1.81548802946766e-05, 
                       1.17586081331547e-08, 1.04933381493906e-18, 8.69003177237522e-09, 
                       1.25737102255664e-07, 1.521368364224e-08, 3.07463190360431e-15, 
                       2.71624618024516e-15, 5.45754609279242e-16, 3.54801244536457e-18, 
                       6.06680919963387e-16, 0, 0, 5.53741845244776e-16, 4.57543192101617e-16, 
                       4.035500306565e-06, 1.38448018644848e-15, 2.28357523470277e-16, 
                       3.50164433365008e-09, 1.04982185528784e-18, 1.80155354516704e-20, 
                       1.76031943153967e-08, 2.26713717025397e-08, 3.07617740058833e-15, 
                       2.71727738109114e-15, 5.45856746729577e-16, 3.54858524386263e-18, 
                       6.06529007332533e-16, 0, 0, 5.53729525872723e-16, 4.57429300960999e-16, 
                       5.52667562836777e-17, 1.38483850302333e-15, 2.28317319030693e-16, 
                       2.11071339010725e-07, 1.04984921723044e-18, 1.80368563782215e-20, 
                       4.16304114923904e-07, 3.59957743709768e-07, 3.07645392476936e-15, 
                       2.71767738262908e-15, 5.45837212723946e-16, 3.54873937278045e-18, 
                       1.04695596623683e-05, 0, 0, 5.53892672634354e-16, 4.57723193665316e-16, 
                       5.53391163764844e-17, 1.38586849331139e-15, 2.28375569146403e-16, 
                       1.70662296285352e-20, 1.05016887884214e-18, 7.24943826997187e-09, 
                       4.08145527091969e-20, 3.03279314444513e-08, 3.07675334288905e-15, 
                       2.71855690767536e-15, 5.45940119405083e-16, 3.54844575131008e-18, 
                       6.06442283392063e-16, 0, 0, 5.53616580251646e-16, 4.57377118676304e-16, 
                       5.52034004502845e-17, 1.38329950347342e-15, 2.28172370659966e-16, 
                       1.72788855803281e-06, 2.17646882525271e-05, 2.08286585068319e-06, 
                       8.3630032839675e-06, 8.80245837133402e-06, 3.07458850136339e-15, 
                       2.7169152518207e-15, 5.45659428688142e-16, 3.54767472925594e-18, 
                       0.00203632935518045, 0, 0, 5.5400893890039e-16, 4.57753758214862e-16, 
                       5.53710660684212e-17, 1.38639537001816e-15, 2.28398735959471e-16, 
                       1.71001362392374e-20, 1.04979912752842e-18, 1.81318327378005e-20, 
                       4.08893759410001e-20, 7.58543864322267e-20, 3.07698004728783e-15, 
                       2.71883462367816e-15, 5.45995101028174e-16, 3.5483698543001e-18, 
                       6.06629418254746e-16, 0, 0, 0.00430141065808926, 0.0107350626393438, 
                       0.00101458935144986, 0.117323770982074, 0.0355958140971443, 5.07230531492053e-21, 
                       0.00131228751826847, 6.27804243097592e-06, 3.32118813569723e-06, 
                       1.21042778537262e-05, 1.6961273087731e-15, 0.262658036673454, 
                       2.95418459481449e-16, 1.52990017477708e-18, 0.444068126621293, 
                       0, 0.12, 5.53920988190776e-16, 4.57614022517756e-16, 5.53325997917627e-17, 
                       1.38580468683616e-15, 2.28421713797372e-16, 1.70670335259674e-20, 
                       1.04994036319521e-18, 3.38074765481358e-08, 4.0824828138808e-20, 
                       1.24294801004246e-07, 3.07676516976993e-15, 2.71810491920808e-15, 
                       5.4594678086735e-16, 3.54847525510276e-18, 6.06956555607273e-16, 
                       0, 0, 0.120859063973899, 0.205316577047122, 0.0101177235900568, 
                       1.38590719782859e-15, 0.261057738125322, 1.70843032264e-20, 1.04996072962833e-18, 
                       1.81116041894363e-20, 4.08632590870358e-20, 7.58178931687813e-20, 
                       3.0764155183177e-15, 2.71838808994713e-15, 5.45943595748913e-16, 
                       3.54808403718052e-18, 6.07000358395707e-16, 0, 0, 5.53632284277713e-16, 
                       4.57476202229876e-16, 5.5231647760902e-17, 1.38355251594827e-15, 
                       2.28262681766117e-16, 2.44077579120263e-07, 1.34248712728197e-07, 
                       4.67890828352723e-07, 4.3070672845506e-07, 8.46596748604629e-07, 
                       3.07529662382417e-15, 2.71658832348756e-15, 5.45727663342379e-16, 
                       3.54824782040945e-18, 6.06905192320929e-16, 0, 0, 4.75394024168362e-16, 
                       3.87512082448239e-16, 4.61719851096267e-17, 1.17085215012571e-15, 
                       1.99750290311364e-16, 7.94910410439221e-21, 8.01188874933143e-19, 
                       8.64006161138866e-21, 1.85171072707102e-20, 3.8528065922213e-20, 
                       2.72301260183966e-15, 2.44276974451419e-15, 4.65706778996044e-16, 
                       2.44396729571917e-18, 0.012960733225241, 0, 0.12, 4.81020395213746e-16, 
                       3.92866771185695e-16, 4.77650526950174e-17, 1.20339795690238e-15, 
                       2.02456998299535e-16, 1.26490200881837e-05, 2.39044692616278e-05, 
                       2.95325618006951e-05, 4.53048496929417e-05, 0.000121252163712256, 
                       0.00458489391924703, 0.00102224609528701, 0.442902428234484, 
                       2.62044796598683e-18, 0.0341679896146713, 0, 0, 5.53624969645967e-16, 
                       4.57469950873721e-16, 5.52293965125339e-17, 1.38347396660093e-15, 
                       2.28263486102493e-16, 1.75341597752659e-07, 1.049664453921e-18, 
                       1.24773985609494e-08, 1.09156950726759e-06, 7.09673595818192e-06, 
                       3.07506850527916e-15, 2.71650466047385e-15, 5.45730215663634e-16, 
                       3.548069916346e-18, 0.000561284726574674, 0, 0, 5.53634259879457e-16, 
                       4.57486658139658e-16, 5.523343373835e-17, 1.3835455346896e-15, 
                       2.28269371040588e-16, 4.42460861191636e-08, 1.04964133842843e-18, 
                       5.55906444273704e-07, 5.74732863766621e-07, 3.62960706102745e-06, 
                       3.07518476431563e-15, 2.71663336389672e-15, 5.45729048036428e-16, 
                       3.54816297137548e-18, 6.06891401029141e-16, 0, 0, 5.53632523656339e-16, 
                       4.57482933255561e-16, 5.52325655045708e-17, 1.38352295089452e-15, 
                       2.28266587597243e-16, 7.75333223789465e-08, 1.04966334881753e-18, 
                       7.1867027466448e-08, 1.10248577386841e-07, 1.3039021804623e-06, 
                       3.07517928831652e-15, 2.71658722995875e-15, 5.45738396323125e-16, 
                       3.54818983501355e-18, 6.06841095157483e-16, 0, 0, 5.53892427919199e-16, 
                       4.57769568839833e-16, 5.53544075494319e-17, 1.38552353732718e-15, 
                       2.28431696270658e-16, 4.52619952777413e-08, 1.04989833640907e-18, 
                       1.80834410577144e-20, 4.08139454789592e-20, 7.5778733639195e-20, 
                       3.0764201543759e-15, 2.71802024266396e-15, 5.45938593312674e-16, 
                       3.54832835545727e-18, 6.06958599658059e-16, 0, 0, 5.53857338457717e-16, 
                       4.57741335813603e-16, 5.533333550125e-17, 1.38545686020388e-15, 
                       2.2840393545092e-16, 1.70350921069772e-20, 1.04986199583752e-18, 
                       8.45558679772896e-07, 1.98556030430863e-06, 3.99433772508963e-07, 
                       3.07699795901119e-15, 2.71787324714373e-15, 5.45985571520366e-16, 
                       3.54887928827084e-18, 6.06957713668687e-16, 0, 0, 5.53627070921718e-16, 
                       4.57486144689733e-16, 5.52318214040098e-17, 1.38348034140549e-15, 
                       2.28267040157364e-16, 1.48927959628095e-08, 1.04963300133567e-18, 
                       2.35234977714712e-07, 9.85321655857016e-08, 4.59980255975226e-06, 
                       3.075058207333e-15, 2.71648039312112e-15, 5.45727408373417e-16, 
                       3.5480741663915e-18, 6.068258690142e-16, 0, 0, 5.53821262762721e-16, 
                       4.57695287577408e-16, 5.53163824146885e-17, 1.38507965496398e-15, 
                       2.28381163220448e-16, 7.6301262334023e-09, 1.04984030529682e-18, 
                       1.80473105569148e-20, 6.76122690763547e-08, 7.57105386365817e-20, 
                       3.07650839710761e-15, 2.71751532798786e-15, 5.45938426063098e-16, 
                       3.54859992576528e-18, 0.0181600328841949, 0, 0, 5.53695000020263e-16, 
                       4.57559856767812e-16, 5.5261373530712e-17, 1.38406396010684e-15, 
                       2.283085509663e-16, 8.90541645389882e-08, 1.04977184767533e-18, 
                       5.36737256522058e-09, 1.3653906240403e-07, 7.56213078990277e-20, 
                       3.07566132929194e-15, 2.71685526339294e-15, 5.45816658887046e-16, 
                       3.54834464491476e-18, 6.0695179386914e-16, 0, 0, 5.53637941131496e-16, 
                       4.57482673506375e-16, 5.52335720879703e-17, 1.38357731750994e-15, 
                       2.28265009975326e-16, 1.4968448772645e-07, 1.04967071177247e-18, 
                       1.55003213782517e-07, 3.29374054682286e-07, 1.94188253506088e-06, 
                       3.07526813584376e-15, 2.71646917258067e-15, 5.457333981603e-16, 
                       3.54824818081031e-18, 6.06845450541117e-16, 0, 0, 5.53632388348296e-16, 
                       4.57478448352421e-16, 5.52298818416634e-17, 1.38343133285137e-15, 
                       2.28263293759256e-16, 1.64274672449163e-08, 1.04963532040229e-18, 
                       4.55413429773548e-09, 5.49814056224444e-08, 7.45768806022394e-08, 
                       3.07492631369965e-15, 2.71631704787267e-15, 5.4574186036885e-16, 
                       3.5479421652178e-18, 6.06798877524709e-16, 0, 0, 5.53625400253864e-16, 
                       4.57476587815241e-16, 5.52311357620741e-17, 1.38342368739741e-15, 
                       2.28263547315899e-16, 3.9644233781845e-07, 1.04967474711189e-18, 
                       1.34802375218347e-06, 9.24339161266942e-07, 6.51066111248305e-06, 
                       3.07494874319055e-15, 2.71635112828389e-15, 5.45697173672106e-16, 
                       3.54798035614052e-18, 0.00151808615167582, 0, 0, 5.53993453381569e-16, 
                       4.57879275703972e-16, 5.54043418342148e-17, 1.38632824453145e-15, 
                       2.28491792669087e-16, 1.70974811883782e-20, 1.04997153379799e-18, 
                       1.81256814405911e-20, 4.09013391321581e-20, 7.58583686665018e-20, 
                       3.07686063519827e-15, 2.71847612808998e-15, 5.4601283706015e-16, 
                       3.54831248027772e-18, 0.0383395274996716, 0, 0, 5.5363518778506e-16, 
                       4.57481929939605e-16, 5.52342933749013e-17, 1.38351820174801e-15, 
                       2.28265527290191e-16, 2.49416505974916e-07, 1.0496661710116e-18, 
                       4.43865446393298e-07, 1.46037928947612e-06, 1.32150232427765e-07, 
                       3.07510419466435e-15, 2.71639960150478e-15, 5.45722182436835e-16, 
                       3.54809479951264e-18, 6.06886206340388e-16, 0, 0, 5.53854898605575e-16, 
                       4.57727372210139e-16, 5.53312102110033e-17, 1.38543895263804e-15, 
                       2.28400568292239e-16, 1.70330583528565e-20, 1.0498820762697e-18, 
                       7.62585141108686e-08, 2.10895412420039e-07, 3.81833628679689e-08, 
                       3.07705979430564e-15, 2.71768350139734e-15, 5.45995136468836e-16, 
                       3.5489772473369e-18, 0.00171817106975169, 0, 0, 5.53894863743583e-16, 
                       4.57771433929809e-16, 5.5349807861991e-17, 1.38569279740243e-15, 
                       2.28427095022809e-16, 1.70491045447633e-20, 1.04990193958621e-18, 
                       1.63275008731797e-07, 7.88143018228095e-08, 7.57641430220643e-20, 
                       3.07708124356473e-15, 2.71791829213347e-15, 5.46007982645449e-16, 
                       3.54886680764558e-18, 6.0704751422474e-16, 0, 0, 5.53964722759652e-16, 
                       4.57858559466363e-16, 7.01556207202139e-05, 1.38616754106774e-15, 
                       2.28477814966646e-16, 1.70893840322283e-20, 1.04996850747931e-18, 
                       1.81161289516359e-20, 4.08853662318777e-20, 7.58418847523453e-20, 
                       3.0768712495214e-15, 2.71828267609845e-15, 5.4599868603657e-16, 
                       3.54844021071121e-18, 6.07045129190323e-16, 0, 0, 5.53885187414143e-16, 
                       4.57765629145842e-16, 5.53553196442713e-17, 1.38543851306219e-15, 
                       2.28427261788252e-16, 3.9930201402456e-06, 1.04991754575935e-18, 
                       1.80837825937027e-20, 4.08148305329258e-20, 7.57802496995964e-20, 
                       3.07619363191698e-15, 2.71780800572368e-15, 5.45916337599703e-16, 
                       3.54812749468536e-18, 6.07024628272071e-16, 0, 0, 0.0174148113004165, 
                       0.0454466731104997, 0.0157976902720696, 0.335097138410128, 0.0288759422741925, 
                       2.4961104173228e-07, 6.55140816865891e-19, 2.65580382623597e-08, 
                       9.46800379756111e-07, 2.20349823195976e-07, 0.968099470476892, 
                       0.319712169894454, 0.0263612850346062, 0.00177822082212584, 0.0187294606016258, 
                       0, 0, 5.53486338794381e-16, 4.57306505544025e-16, 6.39471587095425e-05, 
                       1.38236352558539e-15, 2.28184484834702e-16, 7.15459428683362e-09, 
                       1.04957888738242e-18, 7.80708736767666e-09, 2.46901946243781e-08, 
                       2.95324447180194e-08, 3.07403111175146e-15, 0.00124174679059902, 
                       5.45614462607205e-16, 2.97697844278832e-06, 6.06885494316399e-16, 
                       0, 0, 5.53946520875426e-16, 4.5782450417658e-16, 5.53826760323173e-17, 
                       1.38617878934488e-15, 2.28468000466209e-16, 1.70770520776679e-20, 
                       1.04994338503992e-18, 1.81036833607362e-20, 2.48616543092726e-08, 
                       7.58202438052517e-20, 3.07716259995292e-15, 2.71813504311511e-15, 
                       5.46037994616954e-16, 3.5486136585101e-18, 6.07008285293024e-16, 
                       0, 0, 5.53952059125029e-16, 4.57823659372433e-16, 5.53831993113228e-17, 
                       1.38622759817155e-15, 2.28470150574621e-16, 1.70769739846724e-20, 
                       1.04999476961419e-18, 1.81036252698551e-20, 1.29337755638452e-07, 
                       7.58202751457338e-20, 3.07734261042289e-15, 2.71821100281912e-15, 
                       5.46046572780072e-16, 3.54877407282516e-18, 6.07050554563777e-16, 
                       0, 0, 5.53610662591061e-16, 4.57453692315677e-16, 5.5229226217808e-17, 
                       1.38332538228101e-15, 2.2826192125846e-16, 2.48357366637834e-08, 
                       1.04968863992981e-18, 2.07491935102285e-08, 7.42991967831012e-09, 
                       2.43617809962105e-08, 3.07457149295201e-15, 2.716197318132e-15, 
                       5.45704762738322e-16, 3.54760521763322e-18, 6.06898914061085e-16, 
                       0, 0, 4.92687838144069e-15, 4.1005597476309e-15, 1.98172132848312e-15, 
                       1.07012818828837e-14, 4.77319434507777e-15, 3.56729629332617e-18, 
                       3.86070955221913e-17, 3.87047749578813e-18, 9.39766983682525e-18, 
                       0.00535504762960735, 1.60245285618576e-14, 3.71962360221677e-14, 
                       2.4461992210215e-15, 2.26275881543311e-17, 7.98833675358828e-14, 
                       0, 0.12, 5.53620397592059e-16, 4.5745712192603e-16, 5.52309971188622e-17, 
                       1.38338672575387e-15, 2.28265398735073e-16, 3.16444895351026e-08, 
                       1.0496880489887e-18, 1.59394700425297e-08, 1.76031943153965e-08, 
                       1.69040929359093e-08, 3.07474028115344e-15, 2.71621224985151e-15, 
                       5.45721522047711e-16, 3.54775865255516e-18, 6.06874681923782e-16, 
                       0, 0, 5.04836493933332e-15, 4.2025948335626e-15, 2.24925643455878e-15, 
                       1.09233849882083e-14, 5.10843955216744e-15, 0.999962519458193, 
                       0.998597112022221, 0.999932069690688, 0.999875592698607, 0.994357844254341, 
                       1.62224553035511e-14, 3.87769027601107e-14, 2.46984277874833e-15, 
                       0.998215546364777, 1.48889335132939e-13, 0, 0.12, 5.53990395888211e-16, 
                       4.57869877134978e-16, 5.54052600636795e-17, 1.38638164280226e-15, 
                       2.28497612205037e-16, 1.70960595710066e-20, 1.38347910063639e-07, 
                       1.81243799695087e-20, 4.09012895549626e-20, 7.58613408247491e-20, 
                       3.07696361714886e-15, 2.71840739598381e-15, 5.46021962107811e-16, 
                       3.54832226141641e-18, 6.07030620745061e-16, 0, 0, 5.53773066114721e-16, 
                       4.57628415376535e-16, 5.52978099062178e-17, 1.38476104920083e-15, 
                       2.28358837039969e-16, 1.33148945037416e-08, 1.04980930047193e-18, 
                       1.80335981009859e-20, 8.20417446252675e-06, 7.5683289741799e-20, 
                       3.07629796338152e-15, 0.332154723594422, 0.53073628673086, 3.2558346513586e-06, 
                       0.00392550323282696, 0, 0, 5.53983194156821e-16, 4.5786505127304e-16, 
                       5.54043537389894e-17, 1.38632463272436e-15, 2.28494178589251e-16, 
                       1.70955805518391e-20, 1.04999583592034e-18, 1.81248233011193e-20, 
                       4.08991855038271e-20, 7.58600779923208e-20, 3.07684409034633e-15, 
                       2.71840173131585e-15, 5.46005584456652e-16, 3.54823089248493e-18, 
                       0.132583013766625, 0, 0, 5.53618108836141e-16, 4.57455222976267e-16, 
                       5.52310384019074e-17, 1.38339267687644e-15, 2.28266826845974e-16, 
                       9.75402482765387e-07, 1.04968607138566e-18, 1.11838850082469e-06, 
                       1.28171829781583e-06, 1.30088927448664e-05, 3.07476860085925e-15, 
                       2.71632834851546e-15, 5.45681860568274e-16, 3.54775666670694e-18, 
                       0.268216159249503, 0, 0, 5.5392847355371e-16, 4.57798486477564e-16, 
                       5.53696147890052e-17, 1.38605502854375e-15, 2.28453678600525e-16, 
                       1.70668713535388e-20, 1.04999459590063e-18, 1.80931341969799e-20, 
                       1.07162303058735e-07, 8.78018474291732e-08, 3.0773077815905e-15, 
                       2.71815187072384e-15, 5.46039734533373e-16, 3.54883046237632e-18, 
                       6.06983267895592e-16, 0, 0, 5.53964560759291e-16, 4.57843290928344e-16, 
                       5.5395123542367e-17, 1.38622412012601e-15, 2.28483785806951e-16, 
                       1.70908175160493e-20, 1.04998637693248e-18, 1.81167736027192e-20, 
                       4.08814944030911e-20, 1.24095929322639e-07, 3.07689431670657e-15, 
                       2.71832474306972e-15, 5.46007072660695e-16, 3.54833842667826e-18, 
                       6.07008889902257e-16, 0, 0, 3.9293743455623e-16, 3.20395074526062e-16, 
                       3.77506199967744e-17, 9.72162229698301e-16, 1.624579702646e-16, 
                       6.41691691957844e-21, 6.83516476618174e-19, 7.04912730674743e-21, 
                       6.55811645603212e-08, 3.19335375824904e-20, 2.27731836670469e-15, 
                       0.08267486811007, 3.92557380022726e-16, 2.05889016991361e-18, 
                       4.4882513368033e-16, 0, 0.12, 5.53812330281838e-16, 4.57674644817993e-16, 
                       5.53217025385537e-17, 1.38490768177447e-15, 2.28385275658491e-16, 
                       1.70275926098998e-20, 1.04990979217828e-18, 3.78736678839225e-09, 
                       1.88605653338043e-09, 2.63067460431029e-06, 3.07572797347267e-15, 
                       2.71741853936009e-15, 5.45858784165425e-16, 3.54783319735161e-18, 
                       0.0036660908099728, 0, 0, 5.53840868382287e-16, 4.57707483223866e-16, 
                       5.5329296817488e-17, 1.38539148863264e-15, 2.28401320564331e-16, 
                       1.70332432998946e-20, 5.56773478085793e-06, 4.62360808133823e-07, 
                       5.7496147667566e-08, 1.11149382850653e-06, 3.07688475359683e-15, 
                       2.71772443991737e-15, 5.45970925846424e-16, 3.54874751727735e-18, 
                       0.00177866185893741, 0, 0, 5.53850397464324e-16, 4.57708699839523e-16, 
                       5.53317438424977e-17, 1.38543252457268e-15, 2.28403921613562e-16, 
                       1.70352839602264e-20, 3.1274826070755e-05, 1.27283406550804e-07, 
                       7.44392221970356e-06, 9.43745565070153e-07, 3.07692532166118e-15, 
                       2.71775609124783e-15, 5.45973780114683e-16, 3.54876774981375e-18, 
                       6.06947863148458e-16, 0, 0, 1.08773389136952e-15, 8.99879704290932e-16, 
                       1.20696196748897e-16, 2.68198754602692e-15, 4.843298720598e-16, 
                       3.87724475716716e-20, 2.28863440942085e-18, 4.09734227627101e-20, 
                       9.30496355015084e-20, 1.72310427558586e-19, 5.58724695394839e-15, 
                       5.58872213615913e-15, 9.59823686545269e-16, 6.63437722158525e-18, 
                       1.36986816777933e-15, 0, 0.12, 3.62473034111255e-16, 2.94881785194923e-16, 
                       3.40361295866711e-17, 8.88210679938997e-16, 1.50161296717266e-16, 
                       5.9047632301125e-21, 5.70645531723863e-19, 6.37580828580347e-21, 
                       1.38648034345194e-20, 2.81332420114948e-20, 2.11271122867438e-15, 
                       1.85394701102728e-15, 3.63222697459996e-16, 1.84797337477408e-18, 
                       4.18508402463893e-16, 0, 0.12, 5.53952071037872e-16, 4.5782521186145e-16, 
                       5.53830863026802e-17, 1.38621248730957e-15, 2.28470543213789e-16, 
                       1.70784393391384e-20, 1.05003751380571e-18, 1.81047618063311e-20, 
                       8.96734151994746e-08, 7.58213823690221e-20, 3.07729678535137e-15, 
                       2.71834476241321e-15, 5.46043990110982e-16, 3.54872402639689e-18, 
                       6.06994809121452e-16, 0, 0, 5.53888929937626e-16, 4.57752172396828e-16, 
                       5.53488028287491e-17, 1.38571698474261e-15, 2.28425363742283e-16, 
                       1.70481956649243e-20, 1.04998771061555e-18, 2.11441949527964e-09, 
                       1.00623973741832e-06, 7.57619802816147e-20, 3.07705669305454e-15, 
                       2.71793188236046e-15, 5.46010638376458e-16, 3.54871069923156e-18, 
                       6.06962180203094e-16, 0, 0, 5.53984218465365e-16, 4.5786622673602e-16, 
                       5.54046239530454e-17, 1.38632777922768e-15, 2.28493268877526e-16, 
                       1.70987848778349e-20, 1.0501171565374e-18, 1.81256654908728e-20, 
                       4.08997385097071e-20, 7.58606458896053e-20, 3.07687575889742e-15, 
                       2.71848716239815e-15, 5.46007025152741e-16, 3.54824359963848e-18, 
                       0.00150645330760165, 0, 0, 5.53981685364987e-16, 4.57862633762263e-16, 
                       5.54047229519204e-17, 1.38632625842844e-15, 2.28494582471494e-16, 
                       1.70992520280759e-20, 1.05012009988204e-18, 1.81259778840471e-20, 
                       4.08996886481055e-20, 7.58606194750049e-20, 3.07686840730498e-15, 
                       2.71847988310108e-15, 5.46007073576505e-16, 3.54824215064002e-18, 
                       0.00040016983614732, 0, 0, 5.53933898142041e-16, 4.57808087419679e-16, 
                       5.53794292129999e-17, 1.38599215407139e-15, 2.28462161576848e-16, 
                       1.7077033870022e-20, 1.05004103735274e-18, 7.52129220526737e-08, 
                       4.08534500648315e-20, 7.58185989863558e-20, 3.0768006289435e-15, 
                       2.71821538186486e-15, 5.45988369673005e-16, 3.54835374460499e-18, 
                       6.06992695981793e-16, 0, 0, 5.53851375218276e-16, 4.57713772869974e-16, 
                       5.53318775482627e-17, 1.38543553995469e-15, 2.28404521262459e-16, 
                       1.70349681823869e-20, 1.04994668121456e-18, 9.52650541893129e-09, 
                       4.57225826381291e-08, 1.48756017842036e-07, 3.07688772490072e-15, 
                       2.71774421486717e-15, 5.45991074020044e-16, 3.54872092631223e-18, 
                       6.06947610450237e-16, 0, 0, 5.53918520109895e-16, 4.57792804312179e-16, 
                       5.53673640742838e-17, 1.38595451352375e-15, 2.2844742596666e-16, 
                       1.70644047822923e-20, 1.0500374170705e-18, 1.80915608044666e-20, 
                       5.33811152300929e-08, 5.56840708425116e-09, 3.07708783128046e-15, 
                       2.71813098271695e-15, 5.46021602756522e-16, 3.54863435438536e-18, 
                       0.00327522724908041, 0, 0, 5.53987233371359e-16, 4.57866207121089e-16, 
                       5.54066545120019e-17, 1.38638739849897e-15, 2.28496943458139e-16, 
                       1.7100597405868e-20, 1.05010620862828e-18, 1.81270851061619e-20, 
                       4.09021611912042e-20, 7.58629483703791e-20, 3.07696922095299e-15, 
                       2.71851409577545e-15, 5.46020848470515e-16, 3.54830807182132e-18, 
                       6.07016533217626e-16, 0, 0, 4.94235555338054e-15, 4.11383058607908e-15, 
                       1.99524877071969e-15, 1.07229536873454e-14, 4.79527249422797e-15, 
                       6.81810174697118e-18, 3.88807084433345e-17, 3.99836266707653e-18, 
                       9.73204833467488e-18, 1.73019127056229e-17, 1.60452528198636e-14, 
                       3.72950866219701e-14, 2.4506291262656e-15, 2.26575942231664e-17, 
                       8.08203339428106e-14, 0, 0.12, 5.53980760042341e-16, 4.57863799322947e-16, 
                       5.54043356865488e-17, 1.38632199247611e-15, 2.28495083995155e-16, 
                       1.70989709921532e-20, 1.0500985281806e-18, 1.81258666361911e-20, 
                       4.08992016552633e-20, 7.5860423548529e-20, 3.07686720505444e-15, 
                       2.71847511674967e-15, 5.46006735095756e-16, 3.54823714989917e-18, 
                       0.00990071359152852, 0, 0, 5.69546370064228e-16, 4.70745193981673e-16, 
                       5.71322410371305e-17, 1.42472286641812e-15, 2.354420577219e-16, 
                       1.76517251109768e-20, 1.08278090753641e-18, 1.8708606236898e-20, 
                       4.22280984610017e-20, 7.83173239642691e-20, 3.15606513707228e-15, 
                       2.79866108894418e-15, 5.5948261422887e-16, 3.64254125592029e-18, 
                       6.26560334411212e-16, 0, 0.02, 3.78359645048054e-16, 3.12612409744756e-16, 
                       3.65156372396785e-17, 9.50903358196274e-16, 1.51972665072725e-16, 
                       1.11305848667978e-20, 6.91943878368162e-19, 1.18231583471078e-20, 
                       2.65591612058725e-20, 4.93144110507892e-20, 2.15957786841233e-15, 
                       1.8261067679033e-15, 3.88468869448782e-16, 2.46599222183866e-18, 
                       3.95172216963033e-16, 0, 0.02, 4.78906469751077e-16, 3.90509598390178e-16, 
                       4.66431300065814e-17, 1.18057474464373e-15, 2.00975939210273e-16, 
                       7.98718507934395e-21, 8.21720058498613e-19, 8.71860073840661e-21, 
                       1.85891606353239e-20, 3.91029361254484e-20, 2.73899508557831e-15, 
                       2.45302150130421e-15, 4.68989689189908e-16, 2.47233879862832e-18, 
                       5.6210460672237e-16, 0, 0, 4.79411974883097e-16, 3.90937738932853e-16, 
                       4.67104670772887e-17, 1.18193033966913e-15, 2.01147309023625e-16, 
                       7.99813713390312e-21, 8.24708271295108e-19, 8.7326600589674e-21, 
                       1.85987767201617e-20, 3.91920319987532e-20, 2.74120437062441e-15, 
                       2.45449232112283e-15, 4.69457517538566e-16, 2.47662454279992e-18, 
                       5.62436715799767e-16, 0, 0, 5.46846268445765e-16, 4.50250105614332e-16, 
                       5.34170141499811e-17, 1.33810185578257e-15, 2.24748189255027e-16, 
                       1.24385076313702e-20, 1.0417656706618e-18, 1.46805685323131e-20, 
                       2.64237918901523e-20, 6.78069080462323e-20, 3.00636710448008e-15, 
                       2.67834592869345e-15, 5.35702407158406e-16, 3.37092913588788e-18, 
                       6.04297020417222e-16, 0, 0, 5.53987962681131e-16, 4.57866687893964e-16, 
                       5.54061351097215e-17, 1.38639070756316e-15, 2.28496318321963e-16, 
                       1.70999492205417e-20, 1.05009201142933e-18, 1.81266402390611e-20, 
                       4.09005409334326e-20, 7.58622226999848e-20, 3.07697264584026e-15, 
                       2.71851117129344e-15, 5.46021893076062e-16, 3.54831925593037e-18, 
                       6.07016180978816e-16, 0, 0, 5.02032053943882e-16, 4.10014808339397e-16, 
                       4.90206119440248e-17, 1.23074775819378e-15, 2.08390418188611e-16, 
                       8.48564827920042e-21, 9.36567456315753e-19, 9.5335073166168e-21, 
                       1.92425777588454e-20, 4.45533390706674e-20, 2.81960554352943e-15, 
                       2.51789899426766e-15, 4.89974191086118e-16, 2.69826046940414e-18, 
                       5.77757330809128e-16, 0, 0, 3.17175982506297e-15, 2.64539569477716e-15, 
                       1.42086527687906e-15, 7.42659346268671e-15, 3.21185972796849e-15, 
                       7.55296684884842e-18, 2.74469539856596e-17, 9.47430113041559e-18, 
                       2.70331597729403e-17, 4.32480965316785e-17, 1.14235224366429e-14, 
                       2.56614229718164e-14, 1.56713178082237e-15, 1.48349876408316e-17, 
                       9.82122946934627e-14, 0, 0), dim = c(17L, 82L))
bs_start <- structure(c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                        0, 0, 0, 0, 0.414073942677255, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -5.841780567314, 
                        0, -11.5942759611947, 0, 0, 0, 0, 0, 0, 0.232630641271211, 0, 
                        0, 0, -0.833815353411474, 0.283974359467603, 0, 0, 0, 0, 0, 0, 
                        0, 0, -5.84229697534579, 0, -0.0322545648692377, 0.437078223860374, 
                        0, 0, 0, 0, 0, 0), dim = c(1L, 82L))
gammas_start <- structure(c(13.9723508986897, 14.1571350138438, 16.7770890988125, 
                            13.0582272305153, 15.2340592600761, 24.5576295043462, 20.698769015365, 
                            24.4853450388697, 23.585285239125, 23.0315084957873, 12.0455634598496, 
                            12.6726503997952, 13.5102264750819, 18.7034874820924, 14.3574103485232, 
                            38.5814853911104, 39.9693543568212, 36.3826708366109, 39.000081716248, 
                            39.6802535646106, 18.3691060547097, 18.244409005133, 18.7200466312535, 
                            18.746422004692, 18.7754620985387), dim = c(25L, 1L))
gamma_tilde_start <- structure(-34.2894248693847, dim = c(1L, 1L))


######## Step 2

benzonase_fix_p <- estimate_parameters(W = W,
                                       X = X,
                                       Z = Z,
                                       Z_tilde = Z_tilde,
                                       Z_tilde_gamma_cols = Z_tilde_gamma_cols,
                                       gammas = gammas_start,
                                       gammas_fixed_indices = gammas_fixed_indices,
                                       P = P_start,
                                       P_fixed_indices = P_fixed_indices,
                                       B = bs_start,
                                       B_fixed_indices = B_fixed_indices,
                                       X_tilde = X_tilde,
                                       P_tilde = P_tilde,
                                       P_tilde_fixed_indices = P_tilde_fixed_indices,
                                       gamma_tilde = gamma_tilde_start,
                                       gamma_tilde_fixed_indices = gamma_tilde_fixed_indices, 
                                       barrier_maxit=Inf, 
                                       profiling_maxit=Inf, 
                                       criterion = "Poisson", 
                                       profile_P = TRUE, 
                                       verbose=TRUE)
system("say done")
benzonase_fix_p$optimization_status 

########################################################
######## Step 3
########################################################

benzonase_phats <- benzonase_fix_p$P
colnames(benzonase_phats) <- colnames(benzonase_fix_p$W)
rownames(benzonase_phats) <- colnames(benzonase_fix_p$Z)
benzonase_phats <- benzonase_phats[!grepl("Neg.", rownames(benzonase_phats)) & 
                                     !grepl("Mock", rownames(benzonase_phats)), ]

# saveRDS(benzonase_phats, "../output/benzonase_p_hats_v2.RDS")
