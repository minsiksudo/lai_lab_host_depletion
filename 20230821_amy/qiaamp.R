###### Amy Willis, August 21 2023
###### qiaamp

## Steps
## 1. set up data
## 2. rerun tinyvamp
## 3. save


######## Step 1

library(dplyr)
library(tibble)
library(magrittr)
library(phyloseq)
library(tinyvamp)
ps <- readRDS("../data/PHY_20230521_MGK_host_tidy.rds")
ps_qiaamp_genus <- ps$phyloseq_count %>% 
  tax_glom("Genus") %>%
  phyloseq::subset_samples(treatment == "QIAamp")  %>%
  phyloseq::prune_taxa(taxa_sums(.) > 0, .)
ps_qiaamp_genus
zero_counts <- which(ps_qiaamp_genus %>% sample_sums() == 0) %>% names
ps_qiaamp_genus <- ps_qiaamp_genus %>%
  phyloseq::subset_samples(!(baylor_other_id %in% zero_counts)) %>% # has zero reads
  phyloseq::prune_taxa(taxa_sums(.) > 0, .) 
W <- ps_qiaamp_genus %>% otu_table %>% as.matrix %>% t
jj <- ncol(W) 
nn <- nrow(W) 
sample_ids <- ps_qiaamp_genus %>% sample_data %>% as_tibble %>% pull(sample_id)
subject_ids <- ps_qiaamp_genus %>% sample_data %>% as_tibble %>% pull(subject_id)
treatment_ids <- ps_qiaamp_genus %>% sample_data %>% as_tibble %>% pull(treatment)
specimen_ids <- paste(subject_ids, treatment_ids, sep = "_")
sample_specimen_map <- tibble(sample_ids, specimen_ids)
KK <- specimen_ids %>% unique %>% length
Z <- matrix(0, nrow = nn, ncol = KK)
rownames(Z) <- sample_ids
colnames(Z) <- unique(specimen_ids) 
for (i in 1:nn) {
  Z[i, sample_specimen_map[i, 2] %>% unlist] <- 1
}

stopifnot(all(apply(Z, 1, sum) == 1))


ps_qiaamp_genus %>% 
  subset_samples(subject_id == "Mock") %>%
  taxa_sums() %>% sort %>% tail(10)


P <- matrix(0, nrow = KK, ncol = jj)
rownames(P) <- unique(specimen_ids)
colnames(P) <- ps_qiaamp_genus %>% otu_table %>% rownames
P <- ((t(Z) %*% W ) / (t(Z) %*% W %>% apply(1, sum)))
mock_samples <- which((rownames(P) %>% substr(1, 4)) == "Mock")
neg_samples <- which((rownames(P) %>% substr(1, 4)) == "Neg.")
##########################################
##### this is the line that I needed to fix
##########################################
P[mock_samples, ] <- 0 
P[mock_samples, "Listeria_monocytogenes"] <- 0.12
P[mock_samples, "Pseudomonas_aeruginosa_group"] <- 0.12
P[mock_samples, "Bacillus_intestinalis"] <- 0.12 ## note misclassification
P[mock_samples, "Escherichia_coli"] <- 0.12 
P[mock_samples, "Salmonella_enterica"] <- 0.12 
P[mock_samples, "Lactobacillus_fermentum"] <- 0.12 
P[mock_samples, "Enterococcus_faecalis"] <- 0.12 
P[mock_samples, "Staphylococcus_aureus"] <- 0.12 
P[mock_samples, "Saccharomyces_cerevisiae"] <- 0.02 
P[mock_samples, "Cryptococcus_neoformans"] <- 0.02 
P[neg_samples, ] <- 0

P[mock_samples, ] %>% sum ### checked

P_fixed_indices <- matrix(FALSE, nrow = KK, ncol = jj)
rownames(P_fixed_indices) <- unique(specimen_ids)
colnames(P_fixed_indices) <- colnames(W)
P_fixed_indices[mock_samples, ] <- TRUE
P_fixed_indices[neg_samples, ] <- TRUE

old_bhats <- c(Staphylococcus_aureus = -0.365, Escherichia_coli = 0.478, 
               Pseudomonas_aeruginosa_group = -0.765, 
               Lactobacillus_fermentum = 0.136, Bacillus_intestinalis = 0.3, 
               Listeria_monocytogenes = -0.006, Salmonella_enterica = 0.388, 
               Saccharomyces_cerevisiae = 0.091, Cryptococcus_neoformans = -0.269)
tmts <- treatment_ids %>% unique
pp <- tmts %>% length # 1
B <- matrix(0, nrow = pp, ncol = jj)
colnames(B) <- colnames(W)
rownames(B) <- tmts
B[, names(old_bhats)] <- matrix(old_bhats, nrow = pp, ncol = length(old_bhats),
                                byrow = T)

B_fixed_indices <- matrix(TRUE, nrow = pp, ncol = jj) ## in general, don't estimate efficiencies...
colnames(B_fixed_indices) <- colnames(W)
rownames(B_fixed_indices) <- tmts
B_fixed_indices[, c("Listeria_monocytogenes", "Pseudomonas_aeruginosa_group", 
                    "Bacillus_intestinalis", "Escherichia_coli", 
                    "Salmonella_enterica", "Lactobacillus_fermentum", 
                    "Enterococcus_faecalis", "Staphylococcus_aureus", 
                    "Saccharomyces_cerevisiae", "Cryptococcus_neoformans")] <- FALSE
B_fixed_indices[, "Enterococcus_faecalis"] <- TRUE

X <- matrix(1, nrow = nn, ncol = pp)
gammas_fixed_indices <- rep(FALSE, nn)
gammas <- log(apply(W, 1, sum)) + rnorm(nn)

KK_tilde <- pp
P_tilde <- matrix(0, ncol = jj, nrow = KK_tilde)
P_tilde_fixed_indices <- matrix(FALSE, ncol = jj, nrow = KK_tilde)
neg_profile <- (t(Z) %*% W)[neg_samples, ] 
P_tilde <- matrix(neg_profile / sum(neg_profile), ncol = jj, nrow = KK_tilde)


DNA_bac_ng_uLs <- ps_qiaamp_genus %>% sample_data %>% as_tibble %>% pull(DNA_bac_ng_uL)
Zis <- 1/DNA_bac_ng_uLs
Z_tilde <- matrix(0, nrow = nn, ncol = KK_tilde)
rownames(Z_tilde) <- rownames(Z)
colnames(Z_tilde) <- tmts
specimen_treatment_map <- tibble(specimen_ids, treatment_ids) %>% 
  mutate(treatment_ids = as.character(treatment_ids))
for (i in 1:nn) {
  Z_tilde[i, specimen_treatment_map[i, "treatment_ids"] %>% unlist] <- Zis[i]/exp(mean(log(Zis)))
}

Z_tilde_gamma_cols <- 1

gamma_tilde <- matrix(0, nrow = KK_tilde, ncol = 1)
gamma_tilde_fixed_indices <- matrix(FALSE, nrow = KK_tilde, ncol = 1)

X_tilde <- matrix(0, nrow = KK_tilde, ncol = pp) 

### These initializations come from previous optimization runs and are provided here for reproducibility
P_start <- structure(c(0, 0, 0, 0, 0, 0.000736158189598101, 0, 0.00185624796605915, 
                       0.000339726439234788, 0, 0, 0, 0, 0, 3.35139656876675e-21, 0, 
                       0, 0, 0, 0, 0.00012276327946268, 0, 0.0887993253255044, 0.0676829593975849, 
                       0.15563671970837, 0.299201738760162, 0.327240299884636, 0.0538185916447367, 
                       0, 2.92398069550674e-05, 0, 0.0023122450289994, 0, 0, 5.48783846973029e-06, 
                       9.58154552941474e-06, 2.32778031048055e-05, 1.173472524275e-05, 
                       2.37259941534281e-05, 0.000104247981671591, 9.52005422066764e-05, 
                       0.000184252846887645, 0.000119357369682298, 0.000265179124427126, 
                       0, 0, 0, 0, 3.324781386323e-21, 0, 0, 0, 0, 0, 0, 0, 0.000145763679543008, 
                       0.000192348921594177, 0.00399937061774012, 0.000697798548309122, 
                       0, 0, 0, 0, 0, 3.3218830230048e-21, 0, 0, 0, 0, 0, 0, 0, 0.00215021497069427, 
                       0, 5.19968942445426e-05, 0.00130674216585313, 0.00046878502896885, 
                       0, 0, 0, 0, 3.32298162225585e-21, 0, 0, 0, 0, 0, 0, 0, 3.99674605198529e-05, 
                       0, 0, 8.34229040564967e-22, 0, 0, 0, 0, 0, 3.32051623628953e-21, 
                       0, 0, 0, 0, 0, 0, 0, 0.000102699744320033, 0.000591168584342711, 
                       0.0061643072699328, 0.00293972780883042, 0.00144262480020288, 
                       0, 0, 1.45616568501406e-05, 0, 3.31874555279078e-21, 0, 0, 0.91698982984627, 
                       0.0226030173052474, 0.212126384596222, 0.0815360987198637, 0.426251567932879, 
                       0.000339694743356711, 0.000443132958609062, 9.08230712134355e-05, 
                       0.00127270321227776, 0.00349107159764117, 0, 0, 0, 0, 7.21775784857113e-05, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 0, 0, 0.152414964547954, 0.0964554363122046, 0.211609112645707, 
                       0.156575870942789, 0.0358172151151873, 0.0475481839387623, 0, 
                       0, 0, 0.000922933414836768, 0, 0, 0.0176903803833607, 0.934780405067533, 
                       0.637034009578053, 0.856645200348441, 0.438618846442531, 0.000104362664883348, 
                       0, 0, 0.000230978611846555, 6.3319689284725e-05, 0, 0, 0, 0, 
                       8.47766215655628e-05, 0, 0, 0, 0, 0, 0, 0, 8.99124506386343e-05, 
                       0, 0, 0.000412003957569676, 2.27447250236152e-05, 0, 0, 0, 0, 
                       3.3234129840206e-21, 0, 0, 0, 0, 0, 0, 0, 0.000255803215751931, 
                       0.00104063201379035, 4.73322652094112e-05, 0.00285418836055979, 
                       0.00488938479962696, 0, 0, 0, 0, 3.32124325049978e-21, 0, 0, 
                       0, 0, 0, 0, 0, 0.00112373360661057, 0.00286965112647022, 0.00574064919756455, 
                       0.0108162090468992, 0.0250900310981089, 0, 0, 0, 0, 0.00474813153142243, 
                       0, 0, 8.56483460593903e-07, 0, 0, 0, 0, 0.000280116276383814, 
                       0.00172967941646345, 0.000354100221755107, 0.0031638544252336, 
                       0.000124364907182718, 0, 0, 0, 0, 2.09272268982396e-05, 0, 0, 
                       7.10564056196406e-06, 1.21121117301822e-06, 1.70622640558879e-06, 
                       1.23091523525378e-05, 0, 0.000112677273918971, 0.000222053438599701, 
                       0.000152560808443075, 0.000696251323146357, 0.000458793596190647, 
                       0, 0, 0, 0, 3.3220882025708e-21, 0, 0, 5.17062237321492e-06, 
                       3.48655787661682e-05, 3.53432612586223e-05, 4.88263043317311e-05, 
                       1.92166677792131e-05, 0.000110154220457154, 0.000198922872079112, 
                       0.000153246783301235, 0.000532687520248302, 0.000290685708917877, 
                       0, 0, 0, 0, 3.32118347377582e-21, 0, 0, 0, 0, 0, 0, 0, 1.43355310329458e-06, 
                       0, 0, 8.34074777237229e-22, 8.04188491906487e-06, 0, 0, 0, 0, 
                       3.32311571598796e-21, 0, 0, 0, 0, 0, 0, 0, 4.30065930988429e-06, 
                       0, 9.74084298512388e-06, 7.58140329648546e-05, 1.97797876544655e-05, 
                       0, 0, 0, 0, 3.32153728735815e-21, 0, 0, 0, 0, 0, 0, 0, 1.43355310329447e-06, 
                       0, 0, 8.3437535217478e-22, 1.10474378686148e-05, 0, 0, 0, 0, 
                       3.32189433211474e-21, 0, 0, 2.28395589491715e-05, 3.13617178727956e-06, 
                       4.6616542866975e-06, 0, 0, 0.000214746254873548, 0.000402471857462502, 
                       0.00038812457471727, 0.00154612000171543, 0.000243977791458682, 
                       0, 0, 0, 0, 3.3211156191162e-21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                       8.34111355139682e-22, 1.24283676021906e-05, 0, 0, 0, 0, 3.32152436266108e-21, 
                       0, 0, 2.5060071624785e-06, 2.15638846339133e-05, 1.30099763426142e-05, 
                       4.17690569829479e-05, 1.00592665270233e-05, 3.46346429755975e-05, 
                       0, 3.16920384445543e-05, 5.0616366031942e-05, 7.31486602991687e-05, 
                       0, 0, 0, 0, 3.32087489663325e-21, 0, 0, 0, 0, 0, 0, 0, 0.00135132449729002, 
                       0.00304690430991531, 0, 0.000268554081785191, 5.42217998330838e-05, 
                       0, 0, 0, 0, 0.000101860073780176, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 8.34181330257419e-22, 2.49785819455782e-05, 0, 0, 0, 0, 3.32153567177101e-21, 
                       0, 0, 0, 4.52041312787164e-06, 0, 2.28676697038261e-05, 0, 3.70430121891351e-05, 
                       0, 0, 8.34295834995534e-22, 1.51089959085441e-05, 0, 0, 0, 0, 
                       3.32173277340135e-21, 0, 0, 0, 0.000588259312209797, 0.000414887231516104, 
                       0.000648364084915959, 2.26853803747345e-05, 0.0159065332078157, 
                       0.0512493005824882, 0.0332074941012692, 0.0333491121844341, 0.0346633264760521, 
                       0, 0.000186329848752286, 2.67934486042725e-05, 0, 0.0109073560764525, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 5.21340892161761e-06, 8.34219498503457e-22, 
                       2.31914964080102e-05, 0, 0, 0, 0, 3.3218878697662e-21, 0, 0, 
                       8.29448713169905e-06, 1.01049390961432e-05, 1.43101933151351e-05, 
                       1.78216186191322e-06, 0.000473954486975971, 0, 0.0705535472891889, 
                       0.0016200209347871, 0.00170491437504773, 0.0014890620704489, 
                       0, 0.00214316454599706, 0, 0, 0.0323741432508672, 0, 0.12, 0, 
                       0, 0, 0, 0, 5.29841226977691e-05, 0.000461150452530667, 0.000924694108729117, 
                       8.39922231098535e-05, 0.00119316390539049, 0, 0, 0, 0, 3.32223360541285e-21, 
                       0, 0, 0.0198518274225309, 0, 0, 0, 0.110263227863219, 0, 0, 0, 
                       8.34273570185345e-22, 0, 0, 0, 0, 0, 3.32202196349831e-21, 0, 
                       0, 0, 0, 0, 0, 0, 0.00195330211642536, 0.00135058160516912, 0.00520243332389151, 
                       0.00245831975111699, 0.00475376937667395, 0, 0, 0, 0, 3.32148074180846e-21, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8.3416542682157e-22, 0.000212906872453232, 
                       0, 0, 0, 0, 0.0387375782455544, 0, 0.12, 0, 0, 0, 1.9421107045115e-05, 
                       0, 0.111442009881473, 0.0932098526097824, 0.369796698456678, 
                       0.271340413206253, 0.387803044742236, 0.000491230098222186, 0.00179438196810661, 
                       0.217078423713361, 0, 0.121149851929017, 0, 0, 0, 0, 0, 0, 0, 
                       0.00325731936130734, 0, 0.000660182203442591, 0.00967988268111987, 
                       0.0237412689042179, 0, 0, 0, 0, 0.00277819614229708, 0, 0, 0, 
                       0, 0, 0, 0, 0.000667347640645688, 3.16523541863732e-05, 0.00808448809275334, 
                       0.00412578641199994, 0.016936900104379, 0, 0, 0, 0, 3.32181032158377e-21, 
                       0, 0, 0, 0, 0, 0, 0, 0.00034806669347997, 0, 0.00100934340621945, 
                       1.19357369682311e-05, 0.00124332414718369, 0, 0, 0, 0, 3.32182001510658e-21, 
                       0, 0, 0, 0, 0, 0, 0, 0.000399789289446888, 0, 0, 8.3426243778025e-22, 
                       0, 0, 0, 0, 0, 3.32181193717091e-21, 0, 0, 0, 0, 0, 0, 0, 0.000125980646717541, 
                       0, 0.00639177653288322, 0.00173775488970443, 0.00165207934832218, 
                       0, 0, 0, 0, 3.32180870599664e-21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 8.34163836477985e-22, 0.000150196416316669, 0, 0, 0, 0, 3.32182163069371e-21, 
                       0, 0, 0, 0, 0, 0, 0, 6.38791262828172e-05, 0.000782056628051701, 
                       0.000105365738205289, 0.000566726473824775, 4.21589724544901e-05, 
                       0, 0, 0, 0, 0.0941135831275818, 0, 0, 0, 0, 0, 0, 0, 0.000577779242751895, 
                       2.77566798249796e-05, 3.23780133026729e-05, 0.00133503428311076, 
                       3.00555294954914e-06, 0, 0, 0, 0, 0.000408935097041502, 0, 0, 
                       0, 0, 0, 0, 0, 0.000240320842236304, 0.000595794697646472, 0.00175883953618841, 
                       0.000584630079277235, 0.00184670920959558, 0, 0, 0, 0, 3.32181678393231e-21, 
                       0, 0, 6.75670285579611e-06, 0, 1.16693698810788e-05, 1.57283613393525e-05, 
                       0, 0.00014306859970881, 0.000138539919477219, 0.000189054670894351, 
                       8.44342874419636e-05, 0.000524468989696277, 0, 0, 0, 0, 3.32182001510658e-21, 
                       0, 0, 0, 0, 0, 0, 0, 0.000632770339794246, 0, 0, 0.000204012689290336, 
                       0.00124815740125123, 0, 0, 0, 0, 0.00144824951860794, 0, 0, 0, 
                       0.00280427829710098, 0.0011593503742688, 0.00286360120329398, 
                       0, 0, 0, 0, 8.3425607640591e-22, 0, 0, 0, 0, 0, 3.32182486186798e-21, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8.34236992282891e-22, 0, 0, 0, 
                       0, 0, 0.133411498543265, 0, 0, 0, 0, 0, 0, 0, 0.00139702617022306, 
                       5.30785631740867e-05, 0.00980930327598363, 0.00713712864260721, 
                       0.00123081454842061, 0, 0, 8.28267041636278e-05, 0, 3.32182970862938e-21, 
                       0, 0, 0, 0, 0, 0, 0, 3.97380920233257e-05, 0, 0, 8.34187691631759e-22, 
                       0, 0, 0, 0, 0, 3.32183617097792e-21, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 0, 0.000164447931562293, 1.18597494765997e-05, 0, 0, 0, 0, 
                       0.000570160161410537, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6.64023662643223e-05, 
                       0.000213959136762209, 0, 0, 0.000639392152111334, 0, 0, 0, 0, 
                       0, 0, 0, 0, 0, 0, 4.25478561057808e-05, 0, 0, 8.88549307634676e-05, 
                       7.12803436007978e-05, 0, 0, 0, 0, 3.32181839951944e-21, 0, 0, 
                       0, 0, 0, 0, 0, 0.000849466226888294, 0, 0, 8.34141571667796e-22, 
                       0, 0, 0, 0, 0, 3.32182647745511e-21, 0, 0, 0.00287251864020029, 
                       0.00478666329789303, 0.00632446332361759, 0.00402747258834717, 
                       0.022793951077917, 0.00272099847402585, 0.00678869953401299, 
                       0.00155181232387612, 0.0111165917601368, 0.00171669873658867, 
                       0.889689946981264, 0.545013531319857, 0.0244497208059663, 0.744249405589404, 
                       0.0465081992606352, 0, 0, 0, 1.34747242998279e-05, 0, 1.1625310555175e-05, 
                       3.98208205966186e-05, 0, 0, 0, 8.34184510944589e-22, 1.06818976450196e-05, 
                       0, 0.00109117822384662, 2.38811172342361e-05, 0, 2.30626582143757e-05, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8.34236992282891e-22, 8.08250049946384e-05, 
                       0, 0, 0, 0, 3.32182970862938e-21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 0.00151760685229161, 0, 0.00845204727880667, 0, 0, 0, 3.32183132421652e-21, 
                       0, 0, 0, 0, 0, 0, 0, 4.39240670849417e-05, 5.98959933065619e-05, 
                       0, 8.3415588476006e-22, 2.41256547571938e-05, 0, 0, 0, 0, 3.32183293980365e-21, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3.97030802706508e-20, 0.0266657458283055, 
                       0, 0, 0, 0, 8.9684052923993e-20, 0, 0.12, 0, 0, 0, 0, 0, 4.43828040780064e-05, 
                       9.00874696073922e-06, 9.74084298512282e-06, 8.34232221252137e-22, 
                       1.42966843005583e-05, 0, 0, 0, 0, 3.32182647745511e-21, 0, 0, 
                       0, 0, 0, 0, 0, 0.610177285642791, 0.571072411556785, 0.172934907867058, 
                       0.150088746958548, 0.0881443305013472, 0, 0, 0, 0.0439551571731694, 
                       0, 0, 0.12, 0, 0, 0, 0, 0, 3.95660656509322e-06, 3.31132320719155e-05, 
                       9.32925807026327e-06, 1.48091551272527e-05, 2.76998258323367e-05, 
                       0, 0, 0, 0, 3.32183455539078e-21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 0.00925572195442631, 0, 0, 0.447052527738429, 0.758294552688684, 
                       0.211795437179341, 0.0166950155724006, 0, 0, 0.0425364263085656, 
                       0.0343389181935318, 0.142836926353608, 0.0539704358681453, 0, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8.34233811595721e-22, 
                       0, 0, 0, 0, 0, 0.000585535266886773, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 0, 8.34160655790815e-22, 2.24198003804228e-05, 0, 0, 0, 0, 
                       3.32182809304225e-21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8.34267208811005e-22, 
                       0, 0, 0, 0, 0, 0.18797219574073, 0, 0, 0, 0, 0, 0, 0, 0.00031291597138718, 
                       0, 0, 0.00017107889654465, 0.00096250802430285, 0, 0, 0, 0, 0.290022963498338, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8.34203595067608e-22, 5.90550539006031e-05, 
                       0, 0, 0, 0, 3.32183132421652e-21, 0, 0, 0, 0, 0, 0, 0, 0, 0.000276105920364217, 
                       5.08993344715603e-05, 0.000382827711647604, 0.000493032530467278, 
                       0, 0, 0, 0, 3.32182809304225e-21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 8.3426879915459e-22, 1.68148502853167e-05, 0, 0, 0, 0, 3.32183132421652e-21, 
                       0, 0, 0, 0, 0, 0, 0, 1.89439518357273e-06, 0, 0, 1.6620540735558e-05, 
                       2.86270002409526e-06, 0, 0.00207949414467617, 0, 0, 0, 0, 0.12, 
                       0, 0, 0, 0, 0, 0, 0, 0, 2.16611522756778e-05, 0, 0, 0, 0, 0, 
                       3.32182970862938e-21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8.34267208811005e-22, 
                       0.000997843579250259, 0, 0, 0, 0, 0.00483397587032634, 0, 0, 
                       0, 0, 0, 0, 0, 0, 0.000740421608313282, 0, 7.64771294631118e-05, 
                       0, 0, 0, 0, 0, 0.00102030908285373, 0, 0, 0, 0, 0, 0, 0, 0, 0.0275964702171295, 
                       0, 0.00264420780278851, 0.00178895385426789, 0, 0, 0, 0, 3.32183132421652e-21, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.12, 0, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.12, 0, 0, 0, 0, 
                       0, 0, 0, 0.00010934439238236, 0.00669793772861903, 0, 0, 0, 0, 
                       0, 3.32182970862938e-21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8.3426879915459e-22, 
                       0, 0, 0, 0, 0, 0.000152896882235938, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 0, 8.3426879915459e-22, 0, 0, 0, 0, 0, 0.00128745154050254, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2.34294096043276e-05, 0, 0, 0, 
                       0, 0, 3.32183132421652e-21, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8.34270389498175e-22, 
                       4.18340478112937e-06, 0, 0, 0, 0, 3.32182970862938e-21, 0, 0, 
                       0, 0, 0, 0, 0, 0, 0, 0, 8.34270389498175e-22, 0, 0, 0, 0, 0, 
                       0.000996605795243851, 0, 0, 0, 0, 0, 0, 0.00131755579228422, 
                       0, 0, 0, 8.34270389498175e-22, 0, 0, 0, 0, 0, 3.32182970862938e-21, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6.50871967284559e-20, 0, 0, 0, 
                       0, 0, 1.40499580335413e-19, 0, 0.12, 0, 0, 0, 0, 0.000165388216554652, 
                       0, 0, 0, 8.34270389498175e-22, 0, 0, 0, 0, 0, 0.00573918520522731, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.02, 0, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.02, 0, 0, 0, 0, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8.34270389498175e-22, 
                       0, 0, 0, 0, 0, 3.32182970862938e-21, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                       0, 0, 0), dim = c(17L, 95L))
gammas_start <- structure(c(17.266267695771, 17.6492414202391, 17.3065780970243, 
                            17.4144150613049, 16.4837500481908, 16.6742303326758, 15.2282324807415, 
                            15.801862772222, 15.3249575982671, 17.0191140902272, 11.144958432545, 
                            13.5715986965106, 15.9654324642359, 11.0053424743225, 15.3594270034152, 
                            30.4607311982196, 31.7733645331226, 29.4454066304097, 29.4148432028031, 
                            31.453958810627, 14.8160341668254, 14.9329899679599, 15.0507949134887, 
                            14.809771175247, 14.7256162951844), dim = c(25L, 1L))
bs_start <- structure(c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4.77716687390317, 0, 0, 0, 0, 
                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
                        0, 0, 0, 0, -1.51942954219539, 0, -3.6040929791397, 0, 0, 0, 
                        0, 0, 0, 0, 0, 0, 0, 4.08460979563048, 0, 0, 0, 0, 3.23443397261515, 
                        4.31874094492622, 0, 0, 0, 0, 0, 0, 0, -1.73022571344855, 0, 
                        4.14092874517941, 4.85695918384162, 0, 0, 0, 0, 0, 0), dim = c(1L, 
                                                                                       95L))
gamma_tilde_start <- structure(-25.4557181694959, dim = c(1L, 1L))

######## Step 2
  

qiaamp_fix_p <- estimate_parameters(W = W,
                                    X = X,
                                    Z = Z,
                                    Z_tilde = Z_tilde,
                                    Z_tilde_gamma_cols = Z_tilde_gamma_cols,
                                    gammas = gammas_start,
                                    gammas_fixed_indices = gammas_fixed_indices,
                                    P = P_start,
                                    P_fixed_indices = P_fixed_indices,
                                    B = bs_start,
                                    B_fixed_indices = B_fixed_indices,
                                    X_tilde = X_tilde,
                                    P_tilde = P_tilde,
                                    P_tilde_fixed_indices = P_tilde_fixed_indices,
                                    gamma_tilde = gamma_tilde_start,
                                    gamma_tilde_fixed_indices = gamma_tilde_fixed_indices, 
                                    profiling_maxit=Inf, 
                                    criterion = "Poisson", 
                                    profile_P = TRUE, 
                                    verbose=TRUE)
system("say done")
qiaamp_fix_p$optimization_status #### yay!

########################################################
######## Step 3
########################################################

criterion <- function(threshold) {
  pp <- qiaamp_fix_p$P
  pp[which(qiaamp_fix_p$P <= threshold)] <- 0
  p_totals <- apply(pp, 1, sum)
  pp[p_totals > 0, ] <- (pp / apply(pp, 1, sum))[p_totals > 0, ] 
  print(apply(pp, 1, sum))
  calculate_criterion_lr(W = qiaamp_fix_p$W,
                         X = qiaamp_fix_p$X,
                         Z = qiaamp_fix_p$Z,
                         Z_tilde = qiaamp_fix_p$Z_tilde,
                         Z_tilde_gamma_cols = qiaamp_fix_p$Z_tilde_gamma_cols,
                         Z_tilde_list = qiaamp_fix_p$Z_tilde_list, 
                         alpha_tilde = qiaamp_fix_p$alpha_tilde, 
                         gammas = qiaamp_fix_p$gammas,
                         gammas_fixed_indices = qiaamp_fix_p$gammas_fixed_indices,
                         P = pp,
                         P_fixed_indices = qiaamp_fix_p$P_fixed_indices,
                         B = qiaamp_fix_p$B,
                         B_fixed_indices = qiaamp_fix_p$B_fixed_indices,
                         X_tilde = qiaamp_fix_p$X_tilde,
                         P_tilde = qiaamp_fix_p$P_tilde,
                         P_tilde_fixed_indices = qiaamp_fix_p$P_tilde_fixed_indices,
                         gamma_tilde = qiaamp_fix_p$gamma_tilde,
                         gamma_tilde_fixed_indices = qiaamp_fix_p$gamma_tilde_fixed_indices, 
                         criterion = "Poisson", 
                         wts = NULL)
}
c0 <- criterion(0)
c0

##### look at specific p's
big_grid <- qiaamp_fix_p$P %>% c %>% unique %>% sort
n_options <- big_grid %>% length

cl <- makeCluster(getOption("cl.cores", 6))
clusterExport(cl, "qiaamp_fix_p")
clusterExport(cl, "calculate_criterion_lr")

coarse_grid <- big_grid[round(seq(from = 1, to = n_options, length = 60))]

coarse_grid_vals <- parSapply(cl, X=coarse_grid, FUN=criterion) 
system("say done")

coarse_min <- which.min(coarse_grid_vals)
coarse_endpoints <- coarse_grid[c(max(1, coarse_min-1), (coarse_min+1))]

search_grid <- big_grid[big_grid >= coarse_endpoints[1] & big_grid <= coarse_endpoints[2]]
search_grid_vals <- sapply(X=search_grid, FUN=criterion)

chosen_threshold <- search_grid[which.min(search_grid_vals)] 
chosen_threshold ## 0
##### ok, so that didn't help

########################################################
######## Step 4
########################################################

qiaamp_phats <- qiaamp_fix_p$P
colnames(qiaamp_phats) <- colnames(qiaamp_fix_p$W)
rownames(qiaamp_phats) <- colnames(qiaamp_fix_p$Z)
qiaamp_phats <- qiaamp_phats[!grepl("Neg.", rownames(qiaamp_phats)) & 
                               !grepl("Mock", rownames(qiaamp_phats)), ]

saveRDS(qiaamp_phats, "../output/qiaamp_p_hats_v2.RDS")
