"0",""
"0","my_plot_bar = function (physeq, x = ""Sample"", y = ""Abundance"", fill = NULL, title = NULL, "
"0","                        facet_grid = NULL) {"
"0","    mdf = psmelt(physeq)"
"0","    p = ggplot(mdf, aes_string(x = x, y = y, fill = fill))"
"0","    p = p + geom_bar(stat = ""identity"")"
"0","    p = p + theme(axis.text.x = element_text(angle = -90, hjust = 0)) +"
"0","            scale_x_discrete(drop = F)"
"0","    if (!is.null(facet_grid)) {"
"0","        p <- p + facet_grid(facet_grid)"
"0","    }"
"0","    if (!is.null(title)) {"
"0","        p <- p + ggtitle(title)"
"0","    }"
"0","    return(p)"
"0","}"
"0",""
"0","a <- tax_table(subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Mock"")) %>%"
"0","        cbind(species20 = ""[Other]"") %>%"
"0","        {top20species <- head(taxa_sums(subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Mock"") %>% "
"0","           subset_samples(., S.obs != 0)) %>%"
"0","                                data.frame %>%"
"0","                                arrange(-.) %>%"
"0","                                row.names(), 10)"
"0","   .[top20species, ""species20""] <- as.character(.[top20species, ""Species""])"
"0","   .[, 9] <- gsub(""s__"", "" "", .[, 9])"
"0","   .[, 9] <- gsub(""_"", "" "", .[, 9])"
"0","   .[, 9] <- gsub(""[]]|[[]"", """",  .[, 9])"
"0","   .[, 9] <- gsub("" sp"", "" sp."",  .[, 9])"
"0","   .[, 9] <- gsub("" sp."", ""</i> sp."",  .[, 9])"
"0","   .[, 9] <- gsub("" group"", ""</i> group."",  .[, 9])"
"0","   .[, 9] <- ifelse(grepl(""Other"",.[, 9]),"
"0","                    ""Other"","
"0","                    ifelse(grepl(""</i>"",  .[, 9]),"
"0","                           paste(""<i>"",  .[, 9], sep = """"),"
"0","                           paste(""<i>"",  .[, 9], ""</i>"", sep = """")) %>%"
"0","                            gsub(""s__"", """", .) %>%"
"0","                            gsub(""_"", "" "", .)"
"0","   )"
"0","   phyloseq_temp <- subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Mock"") %>% "
"0","           subset_samples(., S.obs != 0)"
"0","   tax_table(phyloseq_temp) <- tax_table(.) "
"0","   phyloseq_temp"
"0","  } %>%"
"0","        my_plot_bar(., fill=""species20"") + "
"0","        xlab(""Sample"") +"
"0","        ylab("""") +"
"0","        theme_classic(base_size = 11, base_family = ""sans"") +"
"0","        theme(legend.text = element_markdown(size = 6),"
"0","              legend.key.size = unit(3, ""mm""),"
"0","              legend.title = element_text(size = 6),"
"0","              axis.text.x = element_text(color = ""white"")) +"
"0","        guides(fill=guide_legend(title=""Top 10 species"")) +"
"0","        scale_fill_manual(values = c(RColorBrewer::brewer.pal(n = 11, name = ""Paired""))) +"
"0","        facet_wrap (~ treatment, scales = ""free_x"", nrow = 1) +"
"0","        labs(tag = ""A"")"
"0","        #facet_wrap (~ factor(sample_type, levels = c(""Mock"", ""BAL"", ""Nasal"", ""Sputum"")),"
"0","        #            scales= ""free_x"", nrow=2) +"
"0","        "
"0",""
"0",""
"0","b <- tax_table(subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Neg."") %>%"
"0","        subset_samples(.,"
"0","                       baylor_other_id != ""20220606_Neg"") %>%"
"0","                transform_sample_counts(., function(x){ifelse(is.na(x), 0, x)})"
"0","        ) %>%"
"0","        cbind(species20 = ""[Other]"") %>%"
"0","        {top20species <- head(taxa_sums(subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Neg."") %>%"
"0","                                      subset_samples(.,"
"0","                                                     baylor_other_id != ""20220606_Neg"") %>%"
"0","                                      transform_sample_counts(.,"
"0","                                                              function(x){ifelse(is.na(x),"
"0","                                                                                 0, "
"0","                                                                                 x)})"
"0","                              ) %>%"
"0","                                data.frame %>%"
"0","                                arrange(-.) %>%"
"0","                                row.names(), 10)"
"0","   .[top20species, ""species20""] <- as.character(.[top20species, ""Species""])"
"0","   .[, 9] <- gsub(""s__"", "" "", .[, 9])"
"0","   .[, 9] <- gsub(""_"", "" "", .[, 9])"
"0","   .[, 9] <- gsub(""[]]|[[]"", """",  .[, 9])"
"0","   .[, 9] <- gsub("" sp"", "" sp."",  .[, 9])"
"0","   .[, 9] <- gsub("" sp."", ""</i> sp."",  .[, 9])"
"0","   .[, 9] <- gsub("" group"", ""</i> group."",  .[, 9])"
"0","   .[, 9] <- ifelse(grepl(""Other"",.[, 9]),"
"0","                    ""Other"","
"0","                    ifelse(grepl(""</i>"",  .[, 9]),"
"0","                           paste(""<i>"",  .[, 9], sep = """"),"
"0","                           paste(""<i>"",  .[, 9], ""</i>"", sep = """")) %>%"
"0","                            gsub(""s__"", """", .) %>%"
"0","                            gsub(""_"", "" "", .)"
"0","   )"
"0","   phyloseq_temp <- subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Neg."") %>%"
"0","        subset_samples(.,"
"0","                       baylor_other_id != ""20220606_Neg"") %>%"
"0","                transform_sample_counts(., function(x){ifelse(is.na(x), 0, x)})"
"0","   tax_table(phyloseq_temp) <- tax_table(.) "
"0","   phyloseq_temp"
"0","  } %>% "
"0","        my_plot_bar(., fill=""species20"") + "
"0","        ylab("""") +"
"0","        xlab(""Subject"") +"
"0","        theme_classic(base_size = 11, base_family = ""sans"") +"
"0","        theme(legend.text = element_markdown(size = 6),"
"0","              legend.key.size = unit(3, ""mm""),"
"0","              legend.title = element_text(size = 6),"
"0","              axis.text.x = element_text(color = ""white"")) +"
"0","        guides(fill=guide_legend(title=""Top 10 species"")) +"
"0","        scale_fill_manual(values = c(RColorBrewer::brewer.pal(n = 11, name = ""Paired""))) +"
"0","        #facet_wrap (~ treatment, scales = ""free_x"", nrow = 1) +"
"0","        facet_wrap ( ~ treatment,"
"0","                    scales= ""free_x"", nrow=1) +"
"0","        ggtitle(""E    Negative control"")"
"0",""
"0","c <- tax_table(subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""BAL"") %>%"
"0","                transform_sample_counts(., function(x){ifelse(is.na(x), 0, x)})"
"0","        ) %>%"
"0","        cbind(species20 = ""[Other]"") %>%"
"0","        {top20species <- head(taxa_sums(subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""BAL"") %>%"
"0","                                      transform_sample_counts(.,"
"0","                                                              function(x){ifelse(is.na(x),"
"0","                                                                                 0, "
"0","                                                                                 x)})"
"0","                              ) %>%"
"0","                                data.frame %>%"
"0","                                arrange(-.) %>%"
"0","                                row.names(), 10)"
"0","   .[top20species, ""species20""] <- as.character(.[top20species, ""Species""])"
"0","   .[, 9] <- gsub(""s__"", "" "", .[, 9])"
"0","   .[, 9] <- gsub(""_"", "" "", .[, 9])"
"0","   .[, 9] <- gsub(""[]]|[[]"", """",  .[, 9])"
"0","   .[, 9] <- gsub("" sp"", "" sp."",  .[, 9])"
"0","   .[, 9] <- gsub("" sp."", ""</i> sp."",  .[, 9])"
"0","   .[, 9] <- gsub("" group"", ""</i> group."",  .[, 9])"
"0","   .[, 9] <- ifelse(grepl(""Other"",.[, 9]),"
"0","                    ""Other"","
"0","                    ifelse(grepl(""</i>"",  .[, 9]),"
"0","                           paste(""<i>"",  .[, 9], sep = """"),"
"0","                           paste(""<i>"",  .[, 9], ""</i>"", sep = """")) %>%"
"0","                            gsub(""s__"", """", .) %>%"
"0","                            gsub(""_"", "" "", .)"
"0","   )"
"0","   phyloseq_temp <- subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""BAL"") %>%"
"0","           transform_sample_counts(., function(x){ifelse(is.na(x), 0, x)})"
"0","   tax_table(phyloseq_temp) <- tax_table(.) "
"0","   sample_data(phyloseq_temp)$subject_id <- sample_data(phyloseq_temp)$subject_id %>% "
"0","           factor(labels = c(""A"", ""B"", ""C"", ""D"", ""E""))"
"0","   phyloseq_temp"
"0","  } %>% "
"0","        my_plot_bar(., x = ""subject_id"", fill=""species20"") + "
"0","        ylab("""") +"
"0","        theme_classic(base_size = 11, base_family = ""sans"") +"
"0","        theme(legend.text = element_markdown(size = 6),"
"0","              legend.key.size = unit(3, ""mm""),"
"0","              legend.title = element_text(size = 6),"
"0","              axis.title.x = element_blank()) +"
"0","        guides(fill=guide_legend(title=""Top 10 species"")) +"
"0","        scale_fill_manual(values = c(RColorBrewer::brewer.pal(n = 11, name = ""Paired""))) +"
"0","        #facet_wrap (~ treatment, scales = ""free_x"", nrow = 1) +"
"0","        facet_wrap ( ~ treatment,"
"0","                    scales= ""free_x"", nrow=1) +"
"0","        ggtitle(""A    BAL"")"
"0",""
"0",""
"0","d <- tax_table(subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Nasal"") %>% "
"0","           subset_samples(., S.obs != 0)) %>%"
"0","        cbind(species20 = ""[Other]"") %>%"
"0","        {top20species <- head(taxa_sums(subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Nasal"") %>% "
"0","           subset_samples(., S.obs != 0)) %>%"
"0","                                data.frame %>%"
"0","                                arrange(-.) %>%"
"0","                                row.names(), 10)"
"0","   .[top20species, ""species20""] <- as.character(.[top20species, ""Species""])"
"0","   .[, 9] <- gsub(""s__"", "" "", .[, 9])"
"0","   .[, 9] <- gsub(""_"", "" "", .[, 9])"
"0","   .[, 9] <- gsub(""[]]|[[]"", """",  .[, 9])"
"0","   .[, 9] <- gsub("" sp"", "" sp."",  .[, 9])"
"0","   .[, 9] <- gsub("" sp."", ""</i> sp."",  .[, 9])"
"0","   .[, 9] <- gsub("" group"", ""</i> group."",  .[, 9])"
"0","   .[, 9] <- ifelse(grepl(""Other"",.[, 9]),"
"0","                    ""Other"","
"0","                    ifelse(grepl(""</i>"",  .[, 9]),"
"0","                           paste(""<i>"",  .[, 9], sep = """"),"
"0","                           paste(""<i>"",  .[, 9], ""</i>"", sep = """")) %>%"
"0","                            gsub(""s__"", """", .) %>%"
"0","                            gsub(""_"", "" "", .)"
"0","   )"
"0","   phyloseq_temp <- subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Nasal"") %>% "
"0","           subset_samples(., S.obs != 0)"
"0","   tax_table(phyloseq_temp) <- tax_table(.) "
"0","   sample_data(phyloseq_temp)$subject_id <- sample_data(phyloseq_temp)$subject_id %>% "
"0","           factor(labels = c(""A"", ""B"", ""C"", ""D"", ""E"", ""F"", ""G"", ""H"", ""I"", ""J"")) %>%"
"0","           as.character()"
"0","   phyloseq_temp"
"0","  } %>% "
"0","        my_plot_bar(., x = ""subject_id"", fill=""species20"") + "
"0","        ylab("""") +"
"0","        theme_classic(base_size = 11, base_family = ""sans"") +"
"0","        theme(legend.text = element_markdown(size = 6),"
"0","              legend.key.size = unit(3, ""mm""),"
"0","              legend.title = element_text(size = 6),"
"0","              axis.title.x = element_blank()) +"
"0","        guides(fill=guide_legend(title=""Top 10 species"")) +"
"0","        scale_fill_manual(values = c(RColorBrewer::brewer.pal(n = 11, name = ""Paired""))) +"
"0","#        scale_x_discrete(drop=) +"
"0","        facet_wrap(~ treatment,  nrow = 1, drop = T, scales = ""free_x"") +"
"0","        ggtitle(""B    Nasal swabs"")"
"0",""
"0","e <- tax_table(subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Sputum"") %>% "
"0","           subset_samples(., S.obs != 0)) %>%"
"0","        cbind(species20 = ""[Other]"") %>%"
"0","        {top20species <- head(taxa_sums(subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Sputum"") %>% "
"0","           subset_samples(., S.obs != 0)) %>%"
"0","                                data.frame %>%"
"0","                                arrange(-.) %>%"
"0","                                row.names(), 10)"
"0","   .[top20species, ""species20""] <- as.character(.[top20species, ""Species""])"
"0","   .[, 9] <- gsub(""s__"", "" "", .[, 9])"
"0","   .[, 9] <- gsub(""_"", "" "", .[, 9])"
"0","   .[, 9] <- gsub(""[]]|[[]"", """",  .[, 9])"
"0","   .[, 9] <- gsub("" sp"", "" sp."",  .[, 9])"
"0","   .[, 9] <- gsub("" sp."", ""</i> sp."",  .[, 9])"
"0","   .[, 9] <- gsub("" group"", ""</i> group."",  .[, 9])"
"0","   .[, 9] <- ifelse(grepl(""Other"",.[, 9]),"
"0","                    ""Other"","
"0","                    ifelse(grepl(""</i>"",  .[, 9]),"
"0","                           paste(""<i>"",  .[, 9], sep = """"),"
"0","                           paste(""<i>"",  .[, 9], ""</i>"", sep = """")) %>%"
"0","                            gsub(""s__"", """", .) %>%"
"0","                            gsub(""_"", "" "", .)"
"0","   )"
"0","   phyloseq_temp <- subset_samples(phyloseq$phyloseq_rel,"
"0","                              sample_type == ""Sputum"") %>% "
"0","           subset_samples(., S.obs != 0)"
"0","   tax_table(phyloseq_temp) <- tax_table(.) "
"0","   sample_data(phyloseq_temp)$subject_id <- sample_data(phyloseq_temp)$subject_id %>% "
"0","           factor(labels = c(""A"", ""B"", ""C"", ""D"", ""E""))"
"0","   phyloseq_temp"
"0","  } %>%"
"0","        my_plot_bar(., x = ""subject_id"", fill=""species20"")+"
"0","        ylab("""") +"
"0","        theme_classic(base_size = 11, base_family = ""sans"") +"
"0","        theme(legend.text = element_markdown(size = 6),"
"0","              legend.key.size = unit(3, ""mm""),"
"0","              legend.title = element_text(size = 6),"
"0","              axis.title.x = element_blank()) +"
"0","        guides(fill=guide_legend(title=""Top 10 species"")) +"
"0","        scale_fill_manual(values = c(RColorBrewer::brewer.pal(n = 11, name = ""Paired""))) +"
"0","        facet_wrap(~ treatment, scales= ""free_x"", nrow = 1) +"
"0","        ggtitle(""C    Sputum"")"
"0",""
"0",""
"0","fig2 <- ggarrange(c, c %>% lemon::g_legend() %>% as_ggplot,"
"0","                  d, d %>% lemon::g_legend() %>% as_ggplot,"
"0","                  e, e %>% lemon::g_legend() %>% as_ggplot,"
"0","                  #a, a %>% lemon::g_legend() %>% as_ggplot,"
"0","                  #b, b %>% lemon::g_legend() %>% as_ggplot,"
"0","                  ncol=2,nrow=3, widths = c(3, 1),"
"0","                  legend = ""none"","
"0","                  align = ""hv"")"
"0",""
"0","annotate_figure(fig2,"
"0","                left = text_grob(""Relative abundance"","
"0","                                 rot = 90,"
"0","                                 family = ""sans"", "
"0","                                 size = 11),"
"0","                bottom = text_grob(""Subject"","
"0","                                 rot = 0,"
"0","                                 family = ""sans"", "
"0","                                 size = 11)"
"0",")"
